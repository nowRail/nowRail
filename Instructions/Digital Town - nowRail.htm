<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<style type="text/css">
<!--
.style1 {color: #FF9900}
.style9 {
	color: #FF6600;
	font-size: 18px;
}
.style10 {color: #FF0000}
-->
</style>

<meta name="keywords" content="Arduino, ESP 32, ESP8266, C++, C Plus Plus, Programming, Learn">
<meta name="description" content="Digital Town C++ for Arduino, ESP32, ESP8266 Tutorials for beginners">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Digital Town - nowRail</title>
<link href="Digital%20Town%20-%20nowRail_files/prism.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="Digital%20Town%20-%20nowRail_files/dtown.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>
<script src="Digital%20Town%20-%20nowRail_files/prism.js"></script>
<div class="mainbackground" id="maincentre">
<p class="clock">Last Updated: 28/11/2025 </p>
<p class="logo"><img src="Digital%20Town%20-%20nowRail_files/logo.jpg" width="204" height="40"></p>
<table width="950" border="0">
  <tbody><tr>
    <td><div align="center"><a href="https://www.digitaltown.co.uk/index.php" class="navlink">Home</a></div></td>
    <td><div align="center"><a href="https://www.digitaltown.co.uk/lessons.php" class="navlink">Arduino C++ Lessons</a></div></td>
    <td><div align="center"><a href="https://www.digitaltown.co.uk/projects.php" class="navlink">Projects</a></div></td>
    <td><div align="center"><a href="https://www.digitaltown.co.uk/components.php" class="navlink">Components</a></div></td>
    <td><div align="center"><a href="https://www.digitaltown.co.uk/3D.php" class="navlink">3D Printing </a></div></td>
  </tr>
</tbody></table><h1>nowRail</h1>

<h3>Projects &gt;&gt; nowRail</h3>
<h2>Latest News</h2>
<p class="style1">29/11/2025 nowRail v1.5.0  </p>

<p><span class="style1">New Functions </span><br>
    <br>
    <span class="style1">void sendClockTimeChange(byte hour, byte mins, byte seconds, byte day);</span><br>
  This function allows the clock time to be set/updated at any time <br>
</p> 
<p><span class="style1">Mod/Bug fix</span><br>
    <span class="style10"><br>
    </span>
  Mods made to GT911 touch screen code due to changes in the ESP32 libraries (3.2.0 or greater) </p>
<h2>Contents</h2>
<p> I have decided to do seperate tutorials for the different features. 
This will make it easier to add things as new features come along.<br>
    <br>
    Click on the titles below to jump to the section. <br>
    <br>
    I will try and add video tutorails to each section as I get time.
</p><table width="950" border="1">
  <tbody><tr>
    <td><a href="#introduction">Introduction</a></td>
    <td>What is nowRail<span class="style1"> (Video tutorial) </span></td>
  </tr>
  <tr>
    <td><a href="#Tutorials">Video Tutorials </a></td>
    <td valign="top">A list of all the nowRail video tutorials 
      <a href="#Tutorials"> (Latest Videos)<img src="Digital%20Town%20-%20nowRail_files/SystemMonitor.png" alt="How to nowRail loco decoder" width="183" height="103" align="texttop"><img src="Digital%20Town%20-%20nowRail_files/howToLocoDecoder.png" alt="How to nowRail loco decoder" width="183" height="103" align="texttop"></a></td>
  </tr>
  <tr>
    <td><a href="#STARTED">Getting Started </a></td>
    <td>What you need to get started and a tour of the sketch.<span class="style1"> (Video tutorial) </span></td>
  </tr>
  <tr>
    <td><a href="#DOWNLOAD">Download latest Version </a></td>
    <td>Download the latest nowRail sketch </td>
  </tr>
  <tr>
    <td><a href="#Diagnostics">Diagnostics</a></td>
    <td>Turns the diagnostic output to the Serial monitor on or off (Baud rate 115200); </td>
  </tr>
  <tr>
    <td><a href="#stdPinFunctions">Standard Pin Functions </a></td>
    <td><p>Functions that add inputs and outputs that are directly connected to board pins.<br>
      These can be Buttons, Triggers, Sensors, Accessories or control panel LED's. <br>
      Limited in number by the useable board pins<br>
      <a href="https://youtu.be/6pPpFCl5fvU" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/161GettingStartedStandardPins.jpg" alt="Standard Pin functions" width="183" height="103" border="0"></a></p>
	
      <p><span class="style1"><br>
        Button Video tutorials </span> </p>
      <p><span class="style1">LED Video tutorial</span></p>
      <p><span class="style1">SensorVideo tutorial</span></p></td>
  </tr>
  <tr>
    <td><a href="#CD4021">CD4021 Shift register  Pin Functions </a></td>
    <td><p>CD4021 Shift registers are a cheap way of adding as many INPUTpins as required. <br>
      These inputs can be Buttons, Triggers or Sensors that give a digital signal.<br>
      This allows for far more buttons or sensors than your board has pins for</p>
      <p><span class="style1">Button Video tutorial</span> </p>
      <p><span class="style1">SensorVideo tutorial</span></p></td>
  </tr>
    <tr>
    <td><a href="#GT911">GT911 Touch screen Functions</a></td>
    <td>Allows the integration of touch screens with GT911 controller chips for touch screen turnout control panels. <br>
      This allows the building of quite large touch control panels at a fraction of the price of a touch screen LCD. </td>
  </tr>
  
  <tr>
    <td><a href="#74HC595N">74HC595N Shift register  Pin Functions </a></td>
    <td><p>74HC595N Shift registers are a cheap way of adding as many 
OUTPUT pins as required. This allows for far more solenoids, LED's etc 
than your board has pins for.  <span class="style1"><br>
      Solenoid/LED
      Video tutorial </span>  </p>
      <p> <span class="style1">Mimic panel LED Video tutorial</span></p></td>
  </tr>
  <tr>
    <td><a href="#PCA9685Servo">PCA9685 Servos  </a></td>
    <td>Function to add and control a servo connected to PCA9685 servo driver board  <span class="style1">(Video tutorial)</span> </td>
  </tr>
  <tr>
    <td><a href="#PCA9685Led">PCA9685 Leds </a></td>
    <td>Function to add and control a leds connected to PCA9685 boards.<span class="style1"> Effect options</span> are on/off, fire flicker, gas light, arc welder.<span class="style1"> (Video tutorial) </span><br>
      <br>
        <span class="style1">On/Off </span>basic on or OFF led at bightness level set. <br>
      <span class="style1">Fire flicker</span> gives a more visable flicker giving random values between the highest and lowest brightness values.<br>
      <span class="style1">Gas Light</span> gives a far less visable flicker (less flickers and more subtle) between the highest and lowest values.<br>
      <span class="style1">Arc Welder </span>Gives a vigourous on off flicker to  mimic and arc welder effect. Best run between maximum brightness and zero. </td>
  </tr>
  <tr>
    <td><a href="#MASTERCLOCK">MASTERCLOCK</a></td>
    <td>MASTERCLOCK sets a board as the layout MASTERCLOCK that all other boards clocks will sync to. </td>
  </tr>
  <tr>
    <td><a href="#MP3">MP3 Player Functions </a></td>
    <td>Version 1_0_0 introduces MP3 player control. Individual tracks 
can be played or a number of tracks can be played in a random sequence <span class="style1">(Video tutorial) </span></td>
  </tr>
  <tr>
    <td><a href="#timeFunctions">Layout Time Functions  </a></td>
    <td>Functions that interact with the nowRail layout time clock. </td>
  </tr>
  <tr>
    <td><a href="#EEPROM">EEPROM</a></td>
    <td>EEPROM can be configured to store the layout time so that the system continues at the same point after power off.<br>
      When enabled time and loco settings are automatically saved with no user input. </td>
  </tr>
  <tr>
    <td><a href="#JMRI">JMRI</a></td>
    <td>How to connect directly to JMRI as a CMRI node (USB connection directly to ESP32 board.<br>
      Currently supports sensor data being passed to JMRI and Turnout and Lights commands beng passed to nowRail. <span class="style1">(Video tutorial)</span></td>
  </tr>
  <tr>
    <td><a href="#NCE">NCE Cab Bus  connection </a></td>
    <td>How to set nowRail to pass DCC loco and Accessory commands to NCE Cab Bus<br>      <a href="https://youtu.be/HVGBwAo9SNQ" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/163NCECabBus.jpg" alt="nowRail NCE Cab Bus" width="183" height="103" border="0"></a></td>
  </tr>
   <tr>
    <td><a href="#DCCEX">DCC EX connection </a></td>
    <td><p>How to set nowRail to pass DCC loco and Accessory commands to DCC EX<br>
       <a href="https://youtu.be/RgyuyBOvS0g" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/78nowrailDCCEX.jpg" alt="nowRail Connecting to DCC-EX" width="183" height="103" border="0"></a> </p></td>
  </tr>
  <tr>
    <td><a href="#locoFunc">Loco and Accessory control functions</a></td>
    <td>Functions that send instructions to the system to control locos and accessories. Commands passed to DCC-EX if connected. </td>
  </tr>
  
  <tr>
    <td><a href="#locoControl">Loco Controller functions</a></td>
    <td>nowRail has an internal 200 loco roster array storing DCC 
Address, function states and loco name. These functions enable users to 
build their own controllers calling these built in functions.<br>
      Data is saved to EEPROM when EEPROM configured. </td>
  </tr>
  <tr>
    <td><a href="#touchlocoControl">Touch screen Loco Controller</a></td>
    <td>This is an example build of a touch screen loco controller using nowRail.<br>
      Componenets are ESP32 Dev Module, Rotary Encoder Module, 10k Ohm 
resistor, 24LC256 EEPROM chip and 3.5" LCD touch screen (480 x 320) SPI 
version ILI9486 FT6236 or ILI9488 FT6236.<span class="style1">(Video tutorial) </span></td>
  </tr>
  <tr>
    <td><a href="#DCCINPUT">DCC Controller input</a></td>
    <td>A simple way to take Accessory commands from any DCC system and broadcast them over nowRail <br><a href="https://youtu.be/6ZjmP6hau1c" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/80DCCinput.jpg" alt="DCC to nowRail connection" width="183" height="103" border="0"></a></td>
  </tr>
   <tr>
    <td><a href="#Custom">Custom Functions </a></td>
    <td>How to get nowRail to trigger your own custom code </td>
  </tr>
  <tr>
    <td><a href="#Debounce">Button/Sensor Debounce</a></td>
    <td>How to adjust the button debounce sensitivity  </td>
  </tr>
  <tr>
    <td><a href="#TURNOUTPULSE">TURNOUTPULSE</a></td>
    <td>How to adjust the length of a pulse for solenoid type point motors. </td>
  </tr>
  <tr>
    <td><a href="#WIFI">Wifi Channel</a></td>
    <td>Howw to set and swap the channels within nowRAil </td>
  </tr>
</tbody></table>
<p>  <br>
</p><h2><a name="introduction"></a>nowRail - Introduction </h2>
<p><a href="https://youtu.be/Bo2umGG5ktg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/160GettingStarted.png" alt="nowRail getting started Version 1.4.4 or greater" width="425" height="240" border="0"></a>
 </p>
<p>What is nowRail? <br> 
    <br>
    nowRail is a communication protocol for model railways, both analogue and DCC. <br>
    It is distributed free of charge under the MIT license. <br>
    <br>
    The protocol uses <a href="https://www.digitaltown.co.uk/70ESPNOWBroadcast.php" target="_blank">ESP-NOW Broadcast mode</a>, a form of wifi communication that runs without a wifi router as shown in the diagram below. <br>
    <br>
    <br>
    <br>
    <img src="Digital%20Town%20-%20nowRail_files/espNOWBroadcast.jpg" alt="ESP-NOW broadcast mode" width="950" height="554">  </p>
<p>The system is able to connect Loco and Accessory decoders to 
Accessory and Animationscontrollers as well as being able to send loco 
commands to DCC-EX. It can also receive incoming commands from other DCC
 systems. <br>
  <br>
The original system for my own layout "The Isle of Mudd" worked well but
 had a limitation of conventional ESP-NOW (about 20 items) and also 
required some programming skills to add new items.<br>
  <br>
  The nowRail version has been written in a way that makes it very easy 
(often with little or no coding) to add buttons, turnout controls and 
various other items.</p>
<p><img src="Digital%20Town%20-%20nowRail_files/railwaycontrol.jpg" alt="IOM Railway Control" width="950" height="554">
  <br>
</p>
<h2>Hardware Requirements </h2>
<p>Part of the goal of the project was to make the system as affordable 
as possible. As such the system has been built around ESP32 Dev Modules 
(about Â£6,50 on Amazon), as well as various other newer ESP32 boards. 
The code has been tested on  otherESP32 boards but some lack certain 
peripherals such as Serial 2 so make sure the board you choose board 
that has all the features needed for your nowRail set up. <br>
 Although in the early days of nowRail ESP8266 was supported as nowRail 
has grown they with a lack of RAM so will be dropped from futire 
versions of nowRail.<br>
  <br>
  For inputs the system already has built in code for various types of buttons including the old stud and probe type system.<br>
  <br>
  For turnout control the system has built in functions to use servos and solenoid type point motors. <br>
  <br>
  The system also has a built in layout clock with adjustable speeds and
 has functions for triggering events based on layout time with built in 
code to store the current time to EEPROM for when the layout next starts
 up. <br>
  <br>
  All the above functionality works on both analogue and DCC systems.<br>
  <br>
  For those who want to connect to their DCC system there are a couple of options built in.<br>
  <br>
  Commands for locos and accessory decoders can be passed to a DCC-EX 
system while a simple DCC decoder circuit allows the system to broadcast
 accessory decoder command from any DCC system.<br>
</p>
<h2>How it works </h2>
<p>This is a flow diagram of how the system works. Don't worry, you 
don't need to understand but it's for those who are interested. <br>
  <br>
  <img src="Digital%20Town%20-%20nowRail_files/codeFlow.jpg" alt="Code Flow Diagram" width="773" height="728"></p>
<p>Commands are created and transmitted, each command is prefixed with a
 layout code. This stops interferance from other layouts or other items 
broadcasting on an ESP-NOW system.<br>
  <br>
  Each board receives all transmissions and looks through it's list of 
accessories/functions to check if it needs to do anything. This works in
 a similar way to DCC with units ignoring anything that doesn't have the
 units address. <br>
  <br>
  Certain crucial messages will send a responce to say they have been 
received and if not the system will retransit at intervals up to 5 
times.<br>
  <br>
  For some items such as turnout controls a panel response message is also transmitted when the  
  turnout/accessory has processed its command. The panel message is processed by control panels to change status indicators etc.<br>
  <br>
  Due to the nature of the system multiple control panels can control 
the same items ( a number of people with their own control panel)
  but will all receive a panel update no matter which panel sent the 
command. This means all controllers/panels display the latest 
information. <br>
  <br>
  As the system uses broadcast mode new controllers can be added or 
removed without having to change the configuration of any other panel or
 decoder.<br>
  <br>
  Although I have tried to write a lot of very simple functions for those who are not used to coding such as:<br>
  <br>
  </p>
<div>
  <div><span class="style1">myLayout.addPCA9685Servo(0x40,15,300, 10, 160);</span>
 This line would add a servo on PCA9685 board 0x40 that responds to 
accessory address 300. If the direction is 0 the unit will move to 10 
degrees, direction 1 would move to 160 degrees, <br>
  </div>
</div>
<p>All control code incuding the PCA9685 driver board is included within nowRail so no libraries need to be manually added.<br>
  <br>
  In the same way
  buttons are added with lines such as: <br>
  <br>
  </p>
<div>
  <div><span class="style1">myLayout.addStdPinButton(26,100,0,0);</span>//single press pin 26, accNum 100, always sends 0</div>
</div>
<p>and <br>
    <br>
  </p>
<div>
  <div><span class="style1">myLayout.addStdPinButton(33,200,0,1);</span>//single press pin 33, accNum 200, 0 1st press, 1 2nd press</div>
</div>
<br>
All the debouncing, even the pinMode is taken care of internally.<br>
<br>
The system has similar functions to add extra buttons using cheap 74HC595NP and CD4021 shift registers
to allow almost limitel;ess nunmbers of digital inputs and outputs on the system. <br>
  <br>
  <br>
  As well as the simple ways of adding items there are also functions to
 allow the user to create their own custom routines. I have been working
 on a touch screen controller that works in that way. <br>
  <br>
 <h2>Additional Resources for introduction </h2>
 <p><a href="https://www.digitaltown.co.uk/70ESPNOWBroadcast.php">#70 ESP-NOW Broadcast Mode </a>06/03/2024</p>
<p><a href="https://randomnerdtutorials.com/esp-now-esp32-arduino-ide/">Random Nerds Getting Started with ESP-NOW (ESP32 with Arduino IDE) </a></p>

  <br>
  <br>
<h2><a name="DOWNLOAD"></a>The Software - The nowRail sketch </h2>
<span class="style1">Updated 06/04/2024</span><br>
<br>
The basic code contains 5 tabs.<br>
<br>
The main sketch tab that is renamed to whatever you want the item to control.
<br>
<br>
A file called nowRail.cpp and nowRail.h that control the system. The 
code in these may look complicated but the good news is that users do 
not need to edit or even understand these files.<br>
<br>
There is a new tab called customFunctions.ino This contains various 
functions that get called when various events happen to enable users to 
write their own custom driven code. These functions can be deleted if 
not required (most basic installations do not require them). <br>
<br>
Finally there is nowrail_user_setup.h (in early versions this was called
 setup.h) that allows the user to turn on or off certain functions and 
features. <br>
<br>
<table width="950" border="1">
  <tbody><tr>
    <td class="style9">Version</td>
    <td class="style9">Changes</td>
  </tr>
   <tr>
    <td><span class="clock">Future versions </span><br>
      <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_6.zip" target="_blank"></a><br>
      <br></td>
    <td><p>Any suggestions/bugs please email <img src="Digital%20Town%20-%20nowRail_files/address.gif" align="bottom"> or use the github repository at <a href="https://github.com/nowRail/nowRail" target="_blank">https://github.com/nowRail/nowRail</a><br> 
          <br>
          <br>
        </p>
      </td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_5_0.zip" target="_blank">Current Stable Version<br>
      Version 1.5.0 </a><br>
      
      <br></td>
    <td><p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_5_0.zip" target="_blank">Version 1.5.0</a></p>
      <p class="style1">29/11/2025 nowRail v1.5.0 </p>
      <p><span class="style1">New Functions </span><br>
          <br>
          <span class="style1">void sendClockTimeChange(byte hour, byte mins, byte seconds, byte day);</span><br>
        This function allows the clock time to be set/updated at any time <br>
 See <a href="#timeFunctions">Time Functions</a> for details.   </p>
      <p><span class="style1">Mod/Bug fix</span><br>
          <span class="style10"><br>
        </span> Mods made to GT911 touch screen code due to changes in the ESP32 libraries (3.2.0 or greater) </p>
     
      </td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_4_4.zip" target="_blank">Current Stable Version<br>
      Version 1.4.4 </a><br>
      
      <br></td>
    <td><p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_4_4.zip" target="_blank">Version 1.4.4</a></p>
      <p><span class="style1">Additions</span><br>
          <br>
          Ability to set Wifi Channel <br>
          Ability to Encrypt data packets<br>
          Ability to switch wifi channel in real time
          <br>
          <br>
          <br>
          <span class="style1">New Functions </span><br>
    <br>
	<span class="style1">void set74HC595NPPinState(unsigned int chip, unsigned int pin, byte pinState);</span>      <br>
      Allows the pin state on a 74HC595np to be changed without a command being sent.<br>
      useful for turntables/traversers when multiple pins on control panel need updating.      </p>
      <p><span class="style1">Mod/Bug fix</span><br>
            <span class="style10"><br>
            Removal of ESP8266 code</span>. ESP8266 struggles to run 
nowRail and as better and smaller ESP32's are now available they have 
been removed from the code base. <br>
        <br>
        Mod to allow loco commands to run without EEPROM updates for those who don't want to use EEPROM<br>
in functions: <br>
setLocoDCCAddress(byte locoID, int dccAddress) <br>
setLocoName(byte locoID, String locoName) <br>
setLocoDCCFuncState(byte locoID, byte funcNum, byte funcState)</p>
      <p><a href="https://youtu.be/zlGnaPfzrbY" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/159wifi.png" alt="nowRAil wifi channels and encryption" width="425" height="240" border="0"></a>
      </p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_3_3.zip" target="_blank">Current Stable Version<br>
      Version 1.3.3</a><br>
      <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_6.zip" target="_blank"></a><br>
      <br></td>
    <td><p><a href="https://www.digitaltown.co.uk/nowRailV1_3_0" target="_blank">Version 1.3.3</a></p>
      <p><span class="style1">Bug fix in stdPanelPins </span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br> 
          Adds ability to transmit all loco data between controllers <br>
  Ability to change the address of a controller <br>
          <br>
    New Functions <br>
    <br>
    void setnowRailAddr(byte element, int changeVal);<br>
    String getnowRailAddr();<br>
	void locoTXAllLocoData(void);<br>
	void locoRXAllLocoData(int state);      </p>
      <p><span class="style1">Mod/Bug fix</span><br>
        <br>
        Under testing I noticed the ppca9685 servo control system when 
moving a servo at a timed speed would try to start the 1st movement from
 a position of Zero as the current servo position. This has the 
potential to move the servo outside the range the user has decided to 
safely move the servo so the first move now start with the assumption 
the servo is at the centre 90 degree position. all following moves will 
move fro the servos known current position.<br>
        <br>
      Issue found with DCC signal reader, now fixed.. </p>
      <p><br>
        <br>
      </p></td>
  </tr>
   <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_2_1.zip" target="_blank">Current Stable Version<br>
      Version 1.2.1 </a><br>
      <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_6.zip" target="_blank"></a><br>
      <br></td>
    <td><p><span class="style1">Version 1.2.1</span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br> 
          Mods to NCE Cab Bus: Ability to choose if loco addresses 1-128
 will be sent as LONG or SHORT address congidured by: #define 
CAB_BUS_SHORTADDRON 0<br>
          <br>
    2 Extra functions added to allow loco consisting to be added to controllers <br>
    <br>
    locoGetConsistState<br>
    locoSetConsistState<br>
    </p>
      
      
      <p>&nbsp; </p>
      <p><br>
        <br>
      </p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_1_0.zip" target="_blank"><br>
      Version 1.1.0 </a><br>
      <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_6.zip" target="_blank"></a><br>
      <br></td>
    <td><p><span class="style1">Version 1.1.0</span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br> 
          Ability to control the speed of PCA9685 servos to enable slow speed turnout control
<br>
          <br>
        </p>
      </td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_0_1.zip" target="_blank">Version 1.0.1 </a><br>
     <br>
      <br></td>
    <td><p><span class="style1">Version 1.0.1 </span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br>
    MP3 player intergration for DY-SV5W, DY-SV8F, DY-HV8F, DY_HV20T, 
JQ8900 using Serial2 connection. Requires ESP32 Dev Module or other 
ESP32 board with Serial 2 capability<br>
    </p>
      <p><span class="style1">Improvements</span><br>
        <br>
        Serial2 for MP3, DCC EX and NCE Cab bus are now set up internally so no longer need to be configured in setup()<br>
        <br>
        <span class="style1">Bug Fixes</span><br>
      <br>
      MP3 information now only displays when DIAGNOSTICS_ON</p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_9_1.zip" target="_blank">Version 0.9.1</a><br>
     <br>
      <br></td>
    <td><p><span class="style1">Version 0.9.1</span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br>
    PCA9685 Leds control with various effects </p>
      </td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_8_2.zip" target="_blank">Version 0.8.2</a><br>
     <br>
      <br></td>
    <td><p><span class="style1">Version 0.8.2</span><br>
          <br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br>
    NCE Cab bus intergration for Loco speed/function and turnout control </p>
      <p><br>
          2 new functions have been added to customFunctions.ino <br>
          <br>
            <span class="style1">void nowLocoSpeedUpdate(int locoAddr, byte locoSpeed, byte locoDir)</span>;//allows custom code to be triggered by a loco speed command </p>
      <p><span class="style1">void nowLocoFuncUpdate(int locoAddr, byte nowFuncNum, byte nowFuncState)</span>;//allows custom code to be triggered by a loco function command. </p>
      </td>
  </tr>
  <tr>
    <td>ESP-NOW in ESP32 board manager v2+ and v3+ compatible<br><br><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_7_2.zip" target="_blank"> Version 0.7.2 </a><br>
     <br>
      <br></td>
    <td><p><span class="style1">11/06/2024<br>
    </span><span class="style1">Version 0.7.2 </span><br>
          <br>
          This version has had some major changes due to the changes to ESP-NOW in ESP32 board manager v3.0.0<br>
          <br>
          This version works with the old version 2+ as well as the new version 3+
          <br>
          <br>
          <span class="style1">Additions</span><br>
          Extra custom functions for hand controller applications
          <br>
    </p>
      <p><span class="style1">void nowClockSpeedUpdate(void) </span>Triggered when a clock speed change is broadcast, allows fats clocks on all controllers to update </p>
      <p><span class="style1">void nowLocoFuncUpdate(int nowLocoID, byte nowFuncNum, byte nowFuncState) </span>Triggered when a loco function is changed. Allows all controllers to update the functions in controller loco array. <br>
          <br>
          <span class="style1">nowrail_user_setup.h</span><br>
      The old user_setup.h file has been renamed to nowrail_user_setup.h
 to prevent conflicts with other libraries. The file contents remain the
 same </p>
      <p><a href="https://youtu.be/DorqMx6g5p4" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail072update.jpg" alt="nowRail 0.7.2" width="425" height="239" border="0"></a></p></td>
  </tr>
  <tr>
    <td><p><span class="style10">WARNING<br>
      This version works with ESP32 2.0.17 or lower </span><br>
      <br>
      <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_6.zip" target="_blank">Version 0.6.0  </a></p>
      <p>The latest ESP32 board library (3.0.0) has brought major 
changes to some of the library functions. I am currently working on the 
required upgrades. <br>
          <br>
        </p></td>
    <td><p><span class="style1">13/05/2024</span></p>
      <p><span class="style1">Version 0.6 </span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
        Sensors added to nowRail<br>
        </p>
      <p>JMRI integration<br>
        <br>
        Sensor data passes to JMRI, sensors can be connected to ESP32 board pins or via CD4021 shift register for extra pins. <br>
        Turnouts and Lights data is passed from JMRI to nowRAil via CMRI (direct USB connection). <br> 
        <br>
      </p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_5.zip" target="_blank">Version 0.5.0  </a></td>
    <td><p><span class="style1">06/05/2024</span></p>
      <p><span class="style1">Version 0.5 </span><br>
          <br>
          <br>
          <span class="style1">Additions</span><br>
        DCCDECODERPIN now works with a greater number of ESP32 boards. <br>
        <br>
        Thanks to Joe Haydu for the testing <br>
        </p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_4.1.zip" target="_blank">Version 0.4.1  </a></td>
    <td><p><span class="style1">27/04/2024</span><br>
        <br>
        <span class="style1">bug fix</span><br>
      Improved error handling in DCCDECODERPIN<br>
    Thanks to Joe Haydu for the testing </p>
      <p><br> 
          <br>
          <br>
          <span class="style1">Additions</span><br>
          <br>
        Mimic panel commands added.</p>
      addStdPanelLed(int pin,int accNum, int dir);
      //adds a mimic panel pin directly to processor board <br>
      <p>74HC595N Shift register  Pin Mimic panel LED functions //Functions that allow control mimic panel LED's to be added </p>
      <p>        Custom functions now moved to seperate tab to make setting up easier for new users. <br>
        Power Commands added PowerON, Power Off, Emergency Stop... sent automatically to DCC-EX when option selected <br>
        GT911 Touch screen integration <br>
        Loco Roster Data stored in EEPROM <br>
      Loco Roster function to call and set DCC Decoder Address, Function states, Loco Name </p></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_3.zip" target="_blank">Version 0.3  </a></td>
    <td><span class="style1">01/04/2024 </span><br>
      Improvements to 
      74HC595N Accessory functions.<br>
      Standard pin and standard 74HC595N panel pin functions added for control panel LED control<br>
      Improved shiftIn code.<br>
      Odd Serial.print() commands removed.
      <br>
      <br></td>
  </tr>
  <tr>
    <td><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailv0_2.zip" target="_blank">Version 0.2 </a></td>
    <td>Initial Beta Release.      <br></td>
  </tr>
</tbody></table>
<br> 
<br>
<h2><a name="STARTED"></a>Getting Started </h2><br>
<p> <a href="https://youtu.be/Bo2umGG5ktg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/160GettingStarted.png" alt="nowRail, introduction and getting started" width="425" height="239" border="0"></a></p>
<p>Download the zip file from the links above. <br>
  <br>
Open it up in your IDE. I will be using the Arduino IDE v2.3 in Dark Theme mode for the screen shots.<br>
<br>
    <br>
      <span class="clock">ESP32 boards with Arduino IDE </span><br>
    <br>
    If you are using ESP32 boards for the first time you will need to load the ESP32 board library.<br>
      <br>
    The library you need to load is<span class="style1"> esp32 by Expressif Systems</span><br>
    <br>
      You will also need to add a line 
    in your preferences. In Windows go to<span class="style1"> File&gt; Preferences</span>, at the bottom of the Windows you will see a line<br>
    <br>
    <span class="style1">Additional board Manager URL's</span>: Enter the following in that box and<span class="style1"> click OK.
    <br>
      </span><br>
      <span class="style1">https://espressif.github.io/arduino-esp32/package_esp32_index.json</span><br> 
    <br>
</p>
<h2>Function List </h2>

<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><span class="style9"><a name="stdPinFunctions"></a>Standard Pin Functions</span> (functions that use items connected firectly to the board pins) Items connected could be a button, stud and probe, sensor etc. <br>
      <br>
      These functions are limited to the number of usable pins on your board. <br>
      <br>
      This first video shows how to use the <span class="style1">void addStdPinButton(int pin, int accNum, int press1, int press2); </span>function.<br>     </td>
    </tr>
  <tr>
    <td width="353" class="style1">void addStdPinButton(int pin, int accNum, int press1, int press2);	<br></td>
    <td width="581"><p><a href="https://youtu.be/6pPpFCl5fvU" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/161GettingStartedStandardPins.jpg" alt="Standard Pin functions" width="425" height="239" border="0"></a></p>
      <p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/161nowRail.zip" target="_blank">Code for video examples </a></p>
      <p>This connects a standard button to the board using a PULL_DOWN resistor. <br>
          <br>
          <span class="style1">int pin: </span>The board pin the button is connected to.<br>
          <span class="style1">int accNum:</span> accNum is the accessory number you want the button to control. <br>
          <span class="style1">int press1:</span> The direction you want the button to send when pressed the firsdt time.<br>
          <span class="style1">int press2:</span> The direction you wish to be sent when the button is pressed a 2nd time. <br>
          <br>
          <span class="style9">Examples:</span><br>
          <br>
          <span class="style1">myLayout.addStdPinButton(15, 100, 0, 0)</span>;//
pin 15 sends to accessory 100 a command of 0 every time the button is 
pressed. This would usually be paired with a second button that sent a 1
 when pressed to send the opposite command.<br>
          <br>
        <span class="style1">myLayout.addStdPinButton(5, 200, 0, 1)</span>;//
pin 5 sends to accessory 200 a command of 0 first press, 1 second press.
 This is used when you want the same button to be able to switch 
something on and off. </p>
      <p><span class="clock">Other Resources</span></p>
      <p><a href="https://youtu.be/kXDviSgM22w?si=B8pwj_a3K796VceG" target="_blank">digitalRead() and Pull Down resistors and debouncing buttons </a></p>
      <p><a href="https://youtu.be/hAzyEbVkOqM?si=r0TAHsRZ38-VXj75" target="_blank">Controling a relay </a><br>      
        <br>
      </p></td>
  </tr>
  <tr>
    <td class="style1">void addStdPinAcc(int pin, int accNum, int dir, int pulse, int setpinState);</td>
    <td><p><a href="https://youtu.be/6pPpFCl5fvU" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/161GettingStartedStandardPins.jpg" alt="Standard Pin functions" width="425" height="239" border="0"></a></p>
	<p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/161nowRail.zip" target="_blank">Code for video examples </a></p>
    <p>This connects and standard digital output to a pin.<br>
        The digital output could be used to control a solenoid point 
motor (will require a relay or mosfet), or turn a buildings lights 
on/off. <br>
        <br>
        <span class="style1">int pin: </span>The board pin the button is connected to.<br>
        <span class="style1">int accNum:</span> accNum is the accessory number you want the button to control. <br>
        <span class="style1">int dir:</span> The direction you want this function to respond to <br>
        <span class="style1">int pulse:</span> When set to 1 this will 
send a pulse signal (default is 0.5 seconds) for solenoid control. 
Setting the value to 0 leaves the output set to the desired output 
HIGH/LOW until it is reset from another source.<br>
        <span class="style1">int setpinState: </span>This is the signal 
pulse or constant state you want the pin set to. So if set to HIGH the 
pulse would be HIGH, then after 0.5 seonds would go LOW.<br>
        For non Pulse it would set the pin to the value HIGH or LOW<br>
        <br>
        <span class="style9">Examples:</span><br>
        <br>
        Solenoid type point motor:<br>
        <br>
        In this example pin15 triggers a pulse to one coil while pin 2 triggers the opposite direction <br>
        <br>
        <span class="style1">myLayout.addStdPinAcc(15,100,0,1,HIGH)</span>;//pin 15, acc 100, dir 0, PULSE,HIGH...Stall motor... relay or mosfet controlled      <br>
        <br>
        To move the solenoid the other direction would have a line such as <br>
        <br>
        <span class="style1">myLayout.addStdPinAcc(2,100,1,1,HIGH);</span> //pin 2, acc 100, dir 1, PULSE,HIGH...Stall motor... relay or mosfet controlled<br>
        <br>
        ON/OFF switch style control... building lights as an example<br>
        <br>
        In this example both functions control the same pin. <br>
        <br>
        When accessory 200, direction 0 is received the output is set HIGH and left high as pulse is set to 0.<br>
        When accessory 200, direction 1 is received it turns pin 4 low...turns it off.
        <br>
        <br>
        <span class="style1">myLayout.addStdPinAcc(4,200,0,0,HIGH)</span>;//pin 22, acc 200, dir 0, NO PULSE, HIGH...turns pin HIGH...switches ON <br>
        <br>
        <span class="style1">myLayout.addStdPinAcc(4,200,1,0,LOW);</span>//pin 23, acc 200, dir 1, NO PULSE, LOW..on off switch, turns pin 4 LOW, switches off. <br>
        <br>
        <span class="clock">Other Resources</span><br>
        <br>
        <a href="https://youtu.be/PqZu6cGM_i0?si=42OKgCXcucAOsqQ4" target="_blank">Digital Pins and DigitalWrite() - controlling LED's </a><br> 
        <br>
        <a href="https://youtu.be/nsx2KGK868s?si=iWbYKz5Mu79Q5IuM" target="_blank">Solenoid Turnout control using Mosfets        </a><br>
      </p></td>
  </tr>
  <tr>
    <td class="style1">void addStdPanelLed(int pin, int accNum, int dir);</td>
    <td><p><a href="https://youtu.be/6pPpFCl5fvU" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/161GettingStartedStandardPins.jpg" alt="Standard Pin functions" width="425" height="239" border="0"></a></p>
	<p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/161nowRail.zip" target="_blank">Code for video examples </a></p>
    <p>This connects and standard digital output to a pin specifically for displaying LED's on control panels.</p>
    <p>It will respond to a panel command that is sent after a DCC accessory has processed a command.<br>
      <br>
      The panel command informs nowRail that a command has been processed.
      <br>
      <br>
      The LED will be turned on when the appropriate command is received and turned off if the opposite command is received. <br>
      <br>
      <span class="style1">int pin: </span>The board pin the button is connected to.<br>
      <span class="style1">int accNum:</span> accNum is the accessory number you want the button to control. <br>
      <span class="style1">int dir:</span> The direction you want the panel LED to turn on with <br>
      <br>
      <br>
      <span class="style9">Examples:</span><br>
      <br>
      The example below would control 2 LED's to show the turnout durections on a control panel <br>
      <br>
      <span class="style1">myLayout.addStdPanelLed(15, 100, 1);</span>;//pin 15, acc 100, will go HIGH when direction 1 is received and LOW when 0 received. <br>
      <br>
      <br>
      <span class="clock">Other Resources</span><br>
        <br>
        <a href="https://youtu.be/PqZu6cGM_i0?si=42OKgCXcucAOsqQ4" target="_blank">Digital Pins and DigitalWrite() - controlling LED's </a><br> 
        <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">void addStdPinSensor(int pin, int senNum);</td>
    <td><p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/7lko7aTqhqs_003.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
    <p>This connects and standard digital output to a sensor or any type </p>
    <p>It will be polled at intervals set by <span class="style1">SENSORDEBOUNCE 100</span> (defaults to 0.1 seconds) in nowrail_user_setup.h<br>
      <br>
      The sensor changed state will be broadcast with the results visible in the function <br>
      <span class="style1">void nowSensorUpdate(int senNum, byte senInst)</span> that can be found in <span class="style1">customFunctions.ino</span> with the ability for users to set up custom code to deal with the sensor being triggered.<br>
</p>
    <p>If a board is connected to JMRI the sensor data will be transmitted to JMRI over a CMRI connection <br>
      
      <br>
      <br>
      <br>
      <br>
      <span class="style1">int pin: </span>The board pin the sensor is connected to.<br>
      <span class="style1">int senNum:</span> senNum is the sensor number, if using JMRI it is the sensor number without the node number (first digit). <br>
      <br>
      JMRI sensor 1010 would be sensor 10 on node 1. 
      <br>
      <br>
      <br>
      <span class="style9">Examples:</span><br>
      <br>
      <span class="style1">myLayout.addStdPinSensor(15, 100,);</span>;//pin 15, sensor  number 100<br>
      <br>
      <br>
      <br>
      <br> 
      <br>
      <br>
    </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="MASTERCLOCK"></a>MASTERCLOCK_ON<br>
              <br>
      </span>All boards have a clock system built in, however the 
MASTERCLOCK_ON means that the board in question will broadcast the time 
to all other boards at regular intervals to keep all boards in sync.<br>
      If you are using EEPROM to store clock times this is an ideal board to add the EEPROM to.<br>
      <br>
      Ideally the board running as MASTERCLOCK_ON should always be on so
 I use the board that connects my layout to DCC EX as the trains won't 
run wothout it.
      <br>
      <br>
      The following line must be uncommented in nowrail_user_setup.h <br>
      <br>
      <span class="style1">#define MASTERCLOCK_ON   </span> //this board is the master clock and will send out a broadcast to sync all other boards<br>
    </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<a name="timeFunctions"></a><table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><span class="style9">Time Functions</span> nowRail has a built in layout time clock. Thes speed of the clock can be accelerated or stopped as required. </td>
  </tr>
  <tr>
    <td width="353" class="style1"> void sendClockSpeedChange(byte clockSpeed);</td>
    <td width="581">This sets the speed of the layout clock. Accepted values are 0 (stopped) to 255 (255 seconds per real world second). <br>
    <br>
        <br>
      <span class="style1">byte clockSpeed</span>: The value between 0-255 that you want the clock speed set to. </td>
  </tr>
  <tr>
    <td width="353" class="style1"> void sendClockTimeChange(byte hour, byte mins, byte seconds, byte day);</td>
    <td width="581"><p>This function allows the user to set the MASTERCLOCK time either at start up or if they want to jump the clock forwards.<br>
      This function is only processed by MASTERCLOCK boards that will then update the layout. <br>
          <br>
      <br>
        <span class="style1">byte hour </span>: The value between 0-23 that you want the clock hour set to.</p>
      <p><span class="style1">byte mins </span>: The value between 0-59 that you want the clock minutes set to. </p>
      <p><span class="style1">byte seconds </span>: The value between 0-59 that you want the clock seconds set to. </p>
      <p><span class="style1">byte day </span>: The value between 0-6 that you want the clockday set to. <br>
          <br>
        Valus that exceed specified range will be set to 0 <br>
      </p>
      Example:<br>
      <span class="style1">myLayout.sendClockTimeChange(10, 30, 15, 2);</span> Sets the MASTERCLOCK board to 10:30:15 on day 2 
      <p>Added 1.5.0 </p></td>
  </tr>
  <tr>
    <td colspan="2"><span class="clock">Clock Outputs</span><br>
      <br>
      These allow the user to update clocks on the layout both on 
control panels and layout display boards and can be called from custom 
code in the style <br>
      <br>
      <span class="style1"> byte timeHours = myLayout.rtcHours(void);</span></td>
    </tr>
  <tr>
    <td class="style1">byte rtcClockSpeed(void);</td>
    <td><p><br>
      Returns a byte with the value of the current layout clock speed 0-255 <br>
      <br>
      <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">byte rtcHours(void);</td>
    <td><p><br>
      Returns a byte with the value of the current layout Hour 0-23<br>
      <br>
      <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">byte rtcMinutes(void);</td>
    <td><p><br>
      Returns a byte with the value of the current layout minutes 0-59 <br>
      <br>
      <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">byte rtcSeconds(void);</td>
    <td><p><br>
      Returns a byte with the value of the current layout seconds 0-60 <br>
      <br>
      <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">byte rtcDays(void);</td>
    <td><p><br>
      Returns a byte with the value of the current layout day 0-6 <br>
      <br>
      <br>
    </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="CD4021"></a>CD4021 Shift register inputs </span> </p>
      <p>nowrail allows almost limitless amounts of digital inputs (buttons/sensors) to be added using CD4021 shift registers </p>
      <p>        See the tutorial at <a href="https://www.digitaltown.co.uk/71CD4021BEShiftRegister.php" target="_blank">https://www.digitaltown.co.uk/71CD4021BEShiftRegister.php</a> on how to use them<br>
          <br>
        The system defaults to a maximum of 2 chips as defined by the line #define NUMCD4021CHIPS 2<br>
        Changing this value to a higher number will enable more chips to be daisy chained. </p>
      <p>nowRail will configure it's arrays accordingly.
      Each chip adds an extra 8 inputs.<br>
      <br>
      <span class="style1">NOTE:</span> In the circuit diagram the 
CD4021 chips and and buttons/sensors are being powered by the ESP32 3.3v
 output. If a large amount of items are added you may need to supply a 
seperate 3.3v power supply. <br>
      <br>
      I have not added buttons to all the inputs.<br>
      <br>
      nowRail treats the chip closest to the ESP32 as Chip 0.
      <br>
      <br>
      <span class="style9">Components</span><br>
      <br>
      <a href="https://www.amazon.co.uk/dp/B09PDW6WSY?tag=digitaltown09-21" target="_blank">CD4021 </a> <br>
      <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br>
      </p>
      <p><img src="Digital%20Town%20-%20nowRail_files/CD4021ShiftRegister.jpg" alt="ESP32 with CD4021 Shift register" width="936" height="601"></p>
      <p>For more information on the CD4021 Shift register see the tutorial at <a href="https://www.digitaltown.co.uk/71CD4021BEShiftRegister.php">CD4021B Shift Register </a></p></td>
  </tr>
  <tr>
    <td width="353" class="style1"> void setupCD4021(int latchPin, int clockPin, int dataPin);</td>
    <td width="581"><p>This function is called in the setup() function after  <span class="style1">myLayout.init();</span><br>
      <br>
      int latchPin: The board pin connected to the CD4021 latchPin <br>
      int clockPin: The board pin connected to the CD4021 clockPin <br>
      int dataPin:
The board pin connected to the CD4021 dataPin </p>      </td>
  </tr>
  
  <tr>
    <td class="style1"> void addCD4021PinButton(int chip, int pin, int accNum, int press1, int press2);</td>
    <td><p> <iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/gvm_TA42CNg_002.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe><br>
      Works in the same way as adding a standard pin. The only 
difference is the pin is the pin number on the chip and a chip number 
needs to be added with 0 being the chip closest to the processor board 
if multiple chips are being daisy chained,
          <br>
          <br>
          These functions are added in the setup AFTER <span class="style1">void setupCD4021(int latchPin, int clockPin, int dataPin);</span><br>
          <br>
          <span class="style1">int chip:</span> The chip number the pin is on, 0 is closest to the ESP board o the daisy chain <br>
          <span class="style1">int pin: </span>The pin on the CD4021 that is being connected to <br>
          <span class="style1">int accNum:</span> The accessory address you want the button/input to control <br>
          <span class="style1">int press1:</span>Value sent 0/1 on first press <br>
          <span class="style1">int Press2:</span>          Value sent 0/1 on 2nd press<br>
          <br>
          NOTE: system defaults to 
          30 items (more thn one function can be called per pin). 
Chaning the value of the line #define NUMCD4021CHIPSNUMBUTTONS 30 to a 
higher number will enable more items to be added. nowRail will size it's
 arrays accordingly. <br>
          <br>
          Examples:<br>
          <br>
          <span class="style1">myLayout.addCD4021PinButton(0,1,10,0,1);</span>//chip zero, pin 1 will send an instruction to accessory number 10. The instruction will be 0 first press and 1 second press<br> 
          <br>
          <span class="style1">myLayout.addCD4021PinButton(1,0,20,0,0);</span>//chip 1, pin 0 will send an instruction to accessory 20 of 0 every time the button is pressed <br>
          <span class="style1">myLayout.addCD4021PinButton(1,5,20,0,0);</span>//chip 1, pin 5 will send an instruction to accessory 20 of 1 every time the button is pressed <br>
          <br>
          <span class="clock">Setup would look like: </span><br>
          <br>
          <span class="style1">myLayout.init();</span><br>
          <br>
          <span class="style1">myLayout.setupCD4021(12,13,15);</span><br>
          <span class="style1">myLayout.addCD4021PinButton(0,1,10,0,1);</span><br>
          <span class="style1">myLayout.addCD4021PinButton(1,0,20,0,0)</span>;<br>
          <span class="style1">myLayout.addCD4021PinButton(1,5,20,0,0);</span><br>
          <br>
          <br>
        </p>      </td>
  </tr>
  <tr>
    <td width="353" class="style1"> void addCD4021PinSensor(int chip, int pin, int senNum);</td>
    <td width="581"><p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/7lko7aTqhqs_003.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe><br>
      This function adds a sensor to a CD4021 shift register pin <br>
      <br>
    It will be polled at intervals set by <span class="style1">SENSORDEBOUNCE 100</span> (defaults to 0.1 seconds) in nowrail_user_setup.h<br>
          <br>
        The sensor changed state will be broadcast with the results visible in the function <br>
        <span class="style1">void nowSensorUpdate(int senNum, byte senInst)</span> that can be found in <span class="style1">customFunctions.ino</span> with the ability for users to set up custom code to deal with the sensor being triggered.<br>
      </p>      
      <p>If a board is connected to JMRI the sensor data will be transmitted to JMRI over a CMRI connection <br>
          <br>
          <span class="style1">int chip:</span> The chip number the pin is on, 0 is closest to the ESP board o the daisy chain <br>
          <span class="style1">int pin: </span>The board pin the sensor is connected to.<br>
          <span class="style1">int senNum:</span> senNum is the sensor number, if using JMRI it is the sensor number without the node number (first digit). </p>
      <p><span class="clock">Setup would look like: </span><br>
        <br>
        <span class="style1">myLayout.init();</span><br>
        <br>
        <span class="style1">myLayout.setupCD4021(12, 14, 13);//set up the CD4021 chips
        <br>
        //add sensors to CD4021CHIPS
        <br>
        myLayout.addCD4021PinSensor(0, 0, 44);//chip 0, pin 0, sensor 44
  myLayout.addCD4021PinSensor(0, 1, 43);//chip 0, pin 1, sensor 43</span></p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="74HC595N"></a>74HC595N Shift register ouputs </span>nowrail
 allows almost limitless amounts of digital outputs for control of 
various items by using 74HC595N shift registers that are daisly chained.
            <br>
          <br><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/4RajATPS1iM.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
      <br>
      The system defaults to a maximum of 2 chips as defined by the line #define NUM74HC595NCHIPS 2<br>
      Changing this value to a higher number will enable more chips to be daisy chained. </p>
        <p>nowRail will configure it's arrays accordingly.
          Each chip adds an extra 8 outputs. <br>
          <br>
          A typical circuit diagram is shown below. Although the outputs
 shown are connected to LED's, outputs could be connected to Mosfets, 
Transistors, Motor drivers and relays. Anything that accepts a digital 
output. <br>
          <br>
          If using multiple 74HC595N The chip closest to the ESP32 is 
regarded as Chip 0 with daisy chained chips then being Chip 1, Chip2 etc
 <br>
          <br>
          <span class="style9">Components</span><br>
          <br>
          <a href="https://www.amazon.co.uk/dp/B09CD6XX8Y?tag=digitaltown09-21" target="_blank">74HC595N </a> <br>
          <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br>
          <br>
          <img src="Digital%20Town%20-%20nowRail_files/74HC595.jpg" alt="ESP32 with 74HC595 Shift Register" width="950" height="442"></p></td>
  </tr>
  <tr>
    <td width="353" class="style1"> void setup74HC595N(int latchPin, int clockPin, int dataPin);</td>
    <td width="581"><p>This function is called in the setup() function after <span class="style1">myLayout.init();</span><br>
            <br>
      int latchPin: The board pin connected to the 74HC595N latchPin <br>
      int clockPin: The board pin connected to the 74HC595N clockPin <br>
      int dataPin:
      The board pin connected to the 74HC595N dataPin <br>
      <br>
    Example:<br>
    <span class="style1">myLayout.setup74HC595N(14,16,2);</span> //latchPin 14, clockPin 16, dataPin 2 </p></td>
  </tr>
  <tr>
    <td class="style1">void add74HC595NPinAcc(int chip, int pin, int accNum, int dir, int pulse, int setpinState);</td>
    <td><p><br>
      Works in the same way as adding a standard pin. The only 
difference is the pin is the pin number on the chip and a chip number 
needs to be added with 0 being the chip closest to the processor board 
if multiple chips are being daisy chained, <br>
      <br>
      These functions are added in the setup AFTER<span class="style1">void setup74HC595N(int latchPin, int clockPin, int dataPin);</span><br>
      <br>
      <span class="style1">int chip:</span> The chip number the pin is on, 0 is closest to the ESP board o the daisy chain <br>
      <span class="style1">int pin: </span>The pin on the 74HC595N that is being connected to <br>
      <span class="style1">int accNum:</span> The accessory address you want the button/input to control <br>
      <span class="style1">int dir: </span>The direction (0/1) that this pin should respond to. <br>
      <span class="style1">int pulse:</span>0 = Pins stays HIGH of LOW until next instruction. 1 = pin will pulse for 0.5 seconds <br>
      <span class="style1">int setpinState</span>: The state the pin should go to HIGH/LOW or should pulse <br>
      <br>
      NOTE: system defaults to 
      2 x the number of chips defined in NUM74HC595NCHIPS.<br>
      This allows two function per pin so that items can be turned on and another function turn them off.
      <br>
                  <br>
      Examples:<br>
      <br>
      <span class="style1">myLayout.add74HC595NPinAcc(0, 0, 300, 0, 0, HIGH);</span>//chip zero, pin 0 will respond to Accessory Address 300 and will set the pin HIGH <br>
      The same pin would be set LOW by the followsing <br>
      <span class="style1">myLayout.add74HC595NPinAcc(0, 0, 300, 1, 0, LOW);</span><br>
      <br>
      <span class="style1">myLayout.add74HC595NPinAcc(1, 5, 100, 1, 1, HIGH);</span>//chip 1, pin 5 will respond to a direction of 1 with a HIGH pulse  <br>
      <br>
    The following line would set the solenoid in the opposite direction with the opposing coild being driven by pin 4 </p>
      <p><span class="style1">myLayout.add74HC595NPinAcc(1, 4, 100, 0, 1, HIGH);</span>//chip 1, pin 4 will respond to a direction of 0 with a HIGH pulse <br>
          <br>
          <span class="clock">Setup would look like: </span><br>
          <br>
          <span class="style1">myLayout.init();</span><br>
          <br>
          <span class="style1">myLayout.setup74HC595N(14,16,2);<br>
          myLayout.add74HC595NPinAcc(0, 0, 300, 0, 0, HIGH);<br>
          myLayout.add74HC595NPinAcc(0, 0, 300, 1, 0, LOW);<br>
          myLayout.add74HC595NPinAcc(1, 5, 100, 1, 1, HIGH);<br>
          myLayout.add74HC595NPinAcc(1, 4, 100, 0, 1, HIGH);</span><br>
          <br>
          <br>
        </p></td>
  </tr>
   <tr>
    <td class="style1">void add74HC595NPPanelLed(int chip,int pin,int accNum, int dir);</td>
    <td><p>  <iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/nNEkZS6wEMg_002.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>    
    </p>
      <p>Works in the same way as adding a addStdPanelLed(int pin,int accNum, int dir); <br>
          <br>
        These outputs are designed to be used specifically for mimic panel LED's to show track direction.<br>
        <br>
        They respond to Panel Update commands that are sent after an Accessory command has been processed.<br>
        <br>
        They go HIGH when the accNum and dir match the pin setup 
configuration and will go LOW if an accNum command is received for the 
opposte direction.
        <br>
        <br>
        These functions are added in the setup AFTER<span class="style1">void setup74HC595N(int latchPin, int clockPin, int dataPin);</span><br>
        <br>
        <span class="style1">int chip:</span> The chip number the pin is on, 0 is closest to the ESP board o the daisy chain <br>
        <span class="style1">int pin: </span>The pin on the 74HC595N that is being connected to <br>
        <span class="style1">int accNum:</span> The accessory address you want the button/input to control <br>
        <span class="style1">int dir: </span>The direction (0/1) that this pin should respond to. <br>
        <br>
        <br>
        NOTE: system defaults to 
        2 x the number of chips defined in NUM74HC595NCHIPS.<br>
        This allows two function per pin so that items can be turned on and another function turn them off.
        <br>
        <br>
        Examples:<br>
        <br>
        <span class="style1">myLayout.add74HC595NPPanelLed(1,4,300, 0);</span>//chip zero, pin 4 will respond to Accessory Address 300 and will set the pin HIGH if dir = 0 and LOW if dir = 1 <br>
        <br>
        <br>
        The opposite for a turnout would be:<br>
        <br>
        <span class="style1">myLayout.add74HC595NPPanelLed(1,5,300, 1);</span>//chip zero, pin 5 will respond to Accessory Address 300 and will set the pin HIGH if dir = 1 and LOW if dir = 0 <br>
        <br>
        <br>
        <br>
        <span class="clock">Setup would look like: </span><br>
        <br>
        <span class="style1">myLayout.init();</span><br>
        <br>
        <span class="style1">myLayout.setup74HC595N(14,16,2);<br>
          myLayout.add74HC595NPPanelLed(1,4,300, 0);<br>
          myLayout.add74HC595NPPanelLed(1,5,300, 1);<br>
          </span><br>
        <br>
        <br>
      </p></td>
  </tr>
  <tr>
    <td class="style1">void set74HC595NPPinState(unsigned int chip, unsigned int pin, byte pinState);</td>
    <td><p>1.4.4 addition </p>
      <p>This function allows the user to manipulate an output pin without using<br>
          <span class="style1">void add74HC595NPPanelLed(int chip,int pin,int accNum, int dir);</span><br>
        or<br>
        <span class="style1">void add74HC595NPinAcc(int chip, int pin, int accNum, int dir, int pulse, int setpinState);</span><br>
        <br>
        I used this in a traverser project when a button press set the new led but didn't unset all the others.<br>
        would also be used for turntables. <br>
        <br>
        <span class="clock">Called at any time </span><br>
        <br>
        <span class="style1"><br>
        myLayout.set74HC595NPPinState(2, 6, 0); //Set pin 6 on chip 2 to LOW/OFF </span></p>
      <p><span class="style1">myLayout.set74HC595NPPinState(1, 3, 1); //Set pin 3 on chip 1 to HIGH/ON <br>
        </span><br>
          <br>
          <br>
      </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="GT911"></a>GT911 Touch Screen Function  </span>These functions allow users to intergrate touch screens with a GT911 controller<br>
      </p>
      <p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/0s4-Wp4rPuw.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe><br>
          <br>
        These types of screen are ideal for laying over neopixels or LED's to create touch screen mimic panels.
        <br>
        A lot seem to be designed for car sat nav systems. <br>
        <br>
        I buy mine off AliExpress, <a href="https://www.aliexpress.com/w/wholesale-GT911.html?spm=a2g0o.home.search.0" target="_blank">click this link </a>to view screens. <br>
        As you will find they come in a variety of sizes, make sure you pick GT911 versions.<br> 
        <br>
        You will also need a <a href="https://www.aliexpress.com/w/wholesale-FPC%252FFFC-Flexible-Cable-Adapter-Board-0.5mm-Pitch.html?spm=a2g0o.detail.search.0" target="_blank">FPC/FFC Flexible Cable Adapter Board 0.5mm Pitch</a>, make sure you get the 6 Pin 0.5mm spacing so that you can connect to your Arduino.<br>
        <br>
        The pinout connections should be on the flexible ribbon cable as can just be seen in the photo below <br>
        <br>
        <br>
        <img src="Digital%20Town%20-%20nowRail_files/screen.jpg" alt="GT911 Capacitive Touch Screen Arduino" width="800" height="808"><br>
        <br>
        Pin Connections:</p>
      <table width="950" border="0">
        <tbody><tr>
          <td>GT911 Touch Screen </td>
          <td>ESP32 ( I have not tested on ESP8266 but it should work the same) </td>
        </tr>
        <tr>
          <td>VCC</td>
          <td>3.3v </td>
        </tr>
        <tr>
          <td>Gnd</td>
          <td>Gnd</td>
        </tr>
        <tr>
          <td>SDA</td>
          <td>SDA (GPIO 21 ESP32 dev module) </td>
        </tr>
        <tr>
          <td>SCL</td>
          <td>SCL (GPIO 22 ESP32 dev module) </td>
        </tr>
        <tr>
          <td>Reset</td>
          <td>Any suitable free pin (passed in <span class="style1">void addGT911Screen(int GT911ResetPin,int GT911IntPin);</span> ) </td>
        </tr>
        <tr>
          <td>Int</td>
          <td>Any suitable free pin (passed in <span class="style1">void addGT911Screen(int GT911ResetPin,int GT911IntPin);</span> ) </td>
        </tr>
      </tbody></table>
      <p><br>
            <br>
        Debounce is set by the value of <span class="style1">#define BUTTONDEBOUNCE 250</span> in nowrail_user_setup.h</p>
      <p>            In nowrail_user_setup.h the following most be incommented<br>
            <br>
        //GT911 Touch Screen</p>
      <p><span class="style1">#define GT911 0x5D</span>  //Uncomment for gt911 touch screen        </p>
      <p><span class="style1">#define GT911TOUCHBUTTONS 30</span>  //sets the max number of touch point buttons, increase for more buttons.        </p>
      <p><span class="style1">#define GT911TOUCHRADIUS 35</span>   //35 is approx 5mm either side of the centre touch point, increase/decrease to suit preferences...finger size. </p>
      <p>        Also <br>
          <br>
          <span class="style1">#include "Wire.h"        </span><br>
          <br>
          <br>
          <a href="https://www.digitaltown.co.uk/components14ESP32GT911Screen.php" target="_blank">For more information on using GT911 screens see this tutorial</a>. </p></td>
  </tr>
  <tr>
    <td width="353" class="style1">void addGT911Screen(int GT911ResetPin,int GT911IntPin);</td>
    <td width="581"><p>Adds a GT911 touch screen to the system <br>
      Add in <span class="style1">void setup()</span> after <span class="style1">myLayout.init();</span><br>
            <br>
            <span class="style1">int GT911ResetPin:</span> Pin connected to the GT911 Reset Pin<br>
          <span class="style1">int GT911IntPin:</span> Pin connected to the GT911 Int Pin<br>
    </p>
      <p> <br>
            <span class="clock">EXAMPLE</span><br>
          <span class="style1">myLayout.addGT911Screen(15,2);</span>// Adds a GT911 screen Reset pin = 15, int Pin = 2 <br>
          <br>
          <br>
          <br>
      </p></td>
  </tr>
  <tr>
    <td width="353" class="style1">void addGT911Button(int xPos, int yPos, int accNum, int press1, int press2);</td>
    <td width="581"><p>This function adds a touch screen button point<br>
      <br>
      Touch point coordinates cab be found by using <span class="style1">nowGT911Touch(int xPos, int yPos)</span> see below </p>
      <p>Touch points like buttons can be configured as constant value... always sends same command<br>
        <br>
        or on/Off press once for on, 2nd time off
        <br>
        <br>
        <span class="style1">int xPos:</span> x position of touch point<br>
        <span class="style1">int yPos:</span> y position of touch point <br>
        <span class="style1">int accNum:</span> The accessory address you want the button/input to control <br>
        <span class="style1">int press1:</span>Value sent 0/1 on first press <br>
        <span class="style1">int press2:</span> Value sent 0/1 on 2nd press<br>
        <br>
        <span class="clock">EXAMPLES</span><br>
        <br>
        <span class="style1">myLayout.addGT911Button(30, 555, 2000, 0, 0);</span>          //touch point 30/555 sends instruction to AccDecode 2000 to always go to 0 <br>
        <span class="style1">myLayout.addGT911Button(17, 70, 2000, 1, 1);</span>    //touch point17/70 sends instruction to AccDecode 2000 to always go to 1 <br>
    <br>
    <span class="style1">myLayout.addGT911Button(1002, 43, 2001, 0, 1); </span>//double press
    1002/43 sends a command to AccNum 2001 to go 0 first press, 1 second press <br>
        </p>      </td>
  </tr>
  <tr>
    <td class="style1"><p>//triggered by GT911 touch screen touches
      void nowGT911Touch(int xPos, int yPos) {<br>
      Serial.println("custom function nowGT911Touch");<br>
        Serial.print("xPos: ");
        <br>
        Serial.print(xPos);
        <br>
        Serial.print(" yPos: ");
        <br>
        Serial.println(yPos);<br>
      }</p>      </td>
    <td><p>Custom function found in customFunctions.ino<br>
      <br>
      Displays the current touch point to enable setting up of touch 
points, can also have custom code added to make your own touch screen 
functions.
      <br>
      <br>
      <br>
    </p>      </td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="PCA9685Servo"></a>PCA9685Servo Driver Boards and Servos<br>
      </span><br>
      <a href="https://youtu.be/khPnUbnIN88" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/117PCA9586Servo.jpg" alt="nowRail PCA9685 servos" width="425" height="240" border="0"></a> </p>
    <p>nowrail has a built in PCA9685 driver specifically for driving servos.<br>
        <br>
        A typical circuit would be as shown below.<br>
  <br>
        WARNING: The ESP32 supplies 3.3v to the PCA9685 VCC pin. The 
external 5v supply connects to the ESP32 VIN pin and the PCA9685 V+ pin.<br>
        DO NOT CONNECT THE EXTERNAL 5V and ESP32 3.3V TOGETHER
  <br>
  <br>
        All GNDs are common <br>
  <br>
        Each servo should plug into it's own port, shown with common 5v/Gnd to simplify diagram.<br>
        <br>
        <span class="style9">Components</span><br>
        <br>
        <a href="https://www.amazon.co.uk/dp/B0BKZC1XWR?tag=digitaltown09-21" target="_blank">PCA 9685 Board  </a> <br>
        <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br> 
  <br>
  <img src="Digital%20Town%20-%20nowRail_files/servoExample.jpg" alt="nowRail PCA9685 Servo Example" width="835" height="486"><br>
  <br>
        This simplifies the way that servos can be added and controlled.
 Although PCA9685 boards can be daisy chained each board must have it's 
own unique address using the solder tabs.
  <br>
  <br>
        PCA9685 servo boards are configured in the nowrail_user_setup.h<br>
  <br>
        The following lines must be uncommented. <br>
  <br>
  <span class="style1">#include "Wire.h"</span><br>
  <br>
  <span class="style1">#define MAXPCA9685SERVOBOARDS 5</span> //default is 5, increase if required<br>
  <span class="style1">#define SERVOMIN 450 </span>//servo min value...leave these at the default value unless you understand what this setting is. <br>
  <span class="style1">#define SERVOMAX 2000</span>   //servo max value...leave these at the default value unless you understand what this setting is. <br>
  <br>
        Once these lines are uncommented use the function below to add servos <br>
  <br>
        To find the angle that the servo needs to move to try using the <a href="https://www.youtube.com/watch?v=WtLX0ekYmN4" target="_blank">Servo Setter</a> project. <br>
        <br>
        </p></td>
  </tr>
  <tr>
    <td width="353" class="style1"> <p><span class="style10">IMPORTANT</span> From version 1.1.0<br>
      <br>
      void addPCA9685Servo(byte board, byte port, int accNum, int angle0, int angle1, int moveTime);<br>
</p>
      <p>Pre Version 1,1,0 </p>
      <p>void addPCA9685Servo(byte board, byte port, int accNum, int angle0, int angle1);</p></td>
    <td width="581"><p>This function adds a servo to a PCA9685 board <span class="style1"></span>and is placed in the setup() after <span class="style1">myLayout.init();</span><br>
        <br>
            <span class="style1">byte board: </span>//The address of the PCA9685 board the servo is connected to such as 0x40 <br>
          byte port: The port the servo is plugged into 0-15 <br>
          int accNum: The acessory num,ber the servo should respond to <br>
          int angle0: The angle the servo should move to in degrees 0-179 when direction is 0 <br>
          int angle1:The angle the servo should move to in degrees 0-179 when direction is 1</p>
      <p>int moveTime:The time in milliseconds to complete the movement.
 0 = Move instantly, 2000 = takes 2000 milliseconds (2 seconds) to 
complete move. <br>
        <br> 
        <br>
        <br>
        EXAMPLE <br>
        <br>
        myLayout.addPCA9685Servo(0x40,15,300, 10, 
160);//addPCA9685Servo(byte board,byte port,int accNum, int angle0, int 
angle1);<br>
        <br>
        <span class="style1">myLayout.init();</span><br>
        <span class="style1">myLayout.addPCA9685Servo(0x40,15,300, 10, 160, 0)</span>;//
addPCA9685Servo to board 0x40 on port 15 that responds to accessory 
address 300. Direction 0 it will move to 10 degrees. Direction 1 will 
move to 160 degrees and move as fast as possible <br>
        <br>
        <span class="style1">myLayout.addPCA9685Servo(0x42,3,210, 45, 162, 2000)</span>;//
addPCA9685Servo to board 0x42 on port 3 that responds to accessory 
address 210. Direction 0 it will move to 45 degrees. Direction 1 will 
move to 162 degrees and complete the move in 2000 milliseconds (2 
seconds). <br>
        <br>
        <br>
        </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="PCA9685Led"></a>PCA9685Servo Driver Boards and LEDS <br>
      </span><br>
      <a href="https://youtu.be/xKgqPWWVrK8" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail091update.jpg" alt="nowRail pca9685 leds" width="425" height="239" border="0"></a></p>
      <p>nowRail has a built in PCA9685 driver specifically for driving LED's.<br>
        <br>
        A typical circuit would be as shown below.<br>
  <br>
        WARNING: The ESP32 supplies 3.3v to the PCA9685 VCC pin. The 
external 5v supply connects to the ESP32 VIN pin and the PCA9685 V+ pin.<br>
        DO NOT CONNECT THE EXTERNAL 5V and ESP32 3.3V TOGETHER
  <br>
  <br>
        All GNDs are common <br>
        <br>
        IMPORTANT: LED's and Servos CANNOT be connected to the same PCA9685 board as they require different frequencies. <br>
  <br>
        Each LED should plug into it's own port, shown with common 5v/Gnd to simplify diagram.<br>
        Each LED connects between the PWM Pin and GND <br>
        <br>
        <span class="style9">Components</span><br>
        <br>
        <a href="https://www.amazon.co.uk/dp/B0BKZC1XWR?tag=digitaltown09-21" target="_blank">PCA 9685 Board  </a> <br>
        <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br> 
  <br>
  <img src="Digital%20Town%20-%20nowRail_files/pca9685LEDs.png" alt="nowRail PCA9685 LED Servo Example" width="702" height="688"><br>
  <br>
        This simplifies the way that leds can be added and controlled. 
Although PCA9685 boards can be daisy chained each board must have it's 
own unique address using the solder tabs.
  <br>
  <br>
        PCA9685 servo boards are configured in the nowrail_user_setup.h<br>
  <br>
        The following lines must be uncommented. <br>
  <br>
  <span class="style1">#include "Wire.h"</span><br>
  <br>
  <span class="style1">#define MAXPCA9685SERVOBOARDS 5</span> //default is 5, increase if required<br>
  <span class="style1">#define SERVOMIN 450 </span>//servo min value...leave these at the default value unless you understand what this setting is. <br>
  <span class="style1">#define SERVOMAX 2000</span>   //servo max value...leave these at the default value unless you understand what this setting is. <br>
  <br>
        Once these lines are uncommented use the function below to add LED's <br>
        <br>
        <br>
        </p></td>
  </tr>
  <tr>
    <td width="353" class="style1"> void addPCA9685Led(byte board, byte port, int accNum, int dirOn, int effect, int maxBright,int effectBright); 
      <div>        </div></td>
    <td width="581"><p>This function adds a LED to a PCA9685 board <span class="style1"></span>and is placed in the setup() after <span class="style1">myLayout.init();</span><br>
        <br>
        An error message will be seen if you try to connect LED's to the same PCA9685 as a servo.<br> 
        <br>
            <span class="style1">byte board: </span>//The address of the PCA9685 board the servo is connected to such as 0x40 <br>
            <span class="style1">byte port:</span> The port the servo is plugged into 0-15 <br>
            <span class="style1">int accNum:</span> The acessory num,ber the servo should respond to <br>
            <span class="style1">int dirOn:</span> The direction that should switch ON the led (1 or 0); <br>
            <span class="style1">int effect:</span>Type of light 0 = standard on/off, 1 = fire flicker, 2 = gas light, 3 = arc welder <br>
            <span class="style1">int maxBright:</span>The maximum brightness of the LED <br>
            <span class="style1">int effectBright:</span>The lowest brightness furing effects (does not have any effect for effect 0  <br>
        <br>
        EXAMPLE <br>
        <br>
        myLayout.addPCA9685Servo(0x40,15,300, 10, 
160);//addPCA9685Servo(byte board,byte port,int accNum, int angle0, int 
angle1);<br>
        <br>
        <span class="style1">myLayout.init();</span><br>
        <br>
        <span class="style1">myLayout.addPCA9685Led(0x42, 0, 2005, 1, 0, 4095, 0);</span>//
addPCA9685Led to board 0x42 on port 0 that responds to accessory address
 2005 and Direction 1 will turn the LED on at a value of 4095. </p>
      <p><span class="style1">myLayout.addPCA9685Led(0x41, 0, 2006, 1, 1, 4095, 500);</span>//
addPCA9685Led to board 0x41 on port 0 that responds to accessory address
 2006 and Direction 1 will turn the LED on using a fire effect. Max 
brightness 4095 minimum brightness of 500. </p>
      <p><span class="style1">myLayout.addPCA9685Led(0x41, 1, 2007, 0, 2, 250, 20);</span>//
addPCA9685Led to board 0x41 on port 1 that responds to accessory address
 2007 and Direction 0 will turn the LED on using a gas light effect. Max
 brightness 250 minimum brightness of 20. <br>
        <br>
        <span class="style1">myLayout.addPCA9685Led(0x41, 4, 2008, 1, 3, 4095, 0);</span>//
addPCA9685Led to board 0x41 on port 4 that responds to accessory address
 2008 and Direction 1 will turn the LED on using a arc welder effect. 
Max brightness 4095 minimum brightness of 0. <br>
        <br>
        <br>
        <br>
      </p>      </td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="locoFunc"></a>Loco and Accessory control functions  </span>These functions will send commands to DCC EX if it is configured. In the future I hope to exand this to loconet as well. <br>
        <br>
            <br>
          These functions are intended for those building their own loco controllers or custom code accessory controllers. <br>
    </p>      </td>
  </tr>
  <tr>
    <td width="353" class="style1">void sendDCCLocoFunc(int dccAddr, byte funcNum, byte funcState);</td>
    <td width="581"><p>This function is sends a loco function command to a loco decoder <br>
        <br>
            <span class="style1">int dccAddr:</span> The DCC decoder address of the loco <br> 
            <span class="style1">byte funcNum:</span> The DCC decoder function to be set <br> 
            <span class="style1">byte funcState:</span> 0 = turn function off, 1 = turn function on <br>
          <br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1"> myLayout.sendDCCLocoFunc(1024, 3,1);</span>// This will send a command to loco decoder address 1024 to turn ON function 3 <br>
            <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">void sendDCCLocoSpeed(int dccAddr, byte dccSpeed, byte dccDir); </td>
    <td><p>This function is sends a locospeed command to a loco decoder <br>
      <br>
      <span class="style1">int dccAddr:</span> The DCC decoder address of the loco <br>
      <span class="style1">byte dccSpeed:</span> The required speed 0-127 <br>
      <span class="style1">byte dccDir:</span> Direction of travel 1 = forwards, 0 = reverse <br>
      <br>
      <span class="clock">EXAMPLE</span><br>
      <br>
      <span class="style1"> myLayout.sendDCCLocoSpeed(1024, 60,1);</span>// This will send a command to loco decoder address 1024 to set a speed of 60 going forward <br>
      <br>
      <span class="style1">myLayout.sendDCCLocoSpeed(1024, 5, 0);</span>// This will send a command to loco decoder address 1024 to set a speed of 5 in reverse <br>
          <br>
          <br>
      </p>      </td>
  </tr>
  <tr>
    <td class="style1">void sendAccessoryCommand(int accNum, byte accInst, byte respReq); </td>
    <td><p>This function is sends a locospeed command to a loco decoder <br>
      <br>
      <span class="style1">int accNum:</span> The Accessory Address (only addresses 1-2000 will be passed to DCC EX) <br>
      <span class="style1">byte accInst:</span> The instruction to be 
passed( for turnout 0 and 1 ) Higher values could be sent if the 
accessory is designed to cope with it such as a DFPlayer volume <br>
      <span class="style1">byte respReq:</span> 0 = no response MESSRESPNOTREQ or 1 = responce required MESSRESPREQ <br>
      When a command is sent a response can be required. System will 
send message 5 times if no response. If something is constantly changing
 value it is best to turn OFF response. <br>
      <br>
      <span class="clock">EXAMPLE</span><br>
      <br>
      <span class="style1"> myLayout.sendAccessoryCommand(138, 1, MESSRESPREQ) </span>//
 Send a command to accessory decoder 138 to move to position 1 and send a
 response. As the accessory is below 2000 it will be passed to DCC-EX if
 connected <br>
      <br>
      <span class="style1">myLayout.sendAccessoryCommand(3000, 0, MESSRESPNOTREQ); </span>//
 Send a command to accessory decoder 3000 to move to position 0 I do not
 need a response. As the accessory is above 2000 it will NOT be passed 
to DCC-EX if connected <br>
          <br>
          <br>
      </p>      </td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td colspan="2"><p><span class="style9"><a name="locoControl"></a>Loco Controller functions </span>These functions make it easier to create your own loco controller for systems such as DCC-EX.<br>
      <br>
      Internally nowRail stores the DCC Decoder Address, Function Status and Loco Name (max 20 chars). <br>
      <br>
      If EEPROM enabled (#define NOWDisc in nowrail_user_setup.h) any 
changes will be saved to EEPROM and retrieved on system restart <br>
      <br>
        These functions are intended for those building their own loco controllers <br>
        </p></td>
  </tr>
  <tr>
    <td width="353" class="style1">int getLocoDCCAddress(byte locoID);</td>
    <td width="581"><p>This function gets the loco DCC decoder address from the nowRail internal array of 200 locos. <br>
            <br>
            <span class="style1">byte locoID:</span> A value of 0-199 that gets the Decoder number of the loco</p>
      <p>        <br>
        <span class="clock">EXAMPLE</span><br>
        byte myLocoID = 3; <br>
        int DCCAddress;<br>
        DCCArddess = <span class="style1">myLayout.getLocoDCCAddress(myLocoID)</span>;<br>
        Serial,println(DCCAddress); //Serial print the DCC decoder address of LocoID 3 <br>
        <br>
      </p></td>
  </tr>
  <tr>
    <td width="353" class="style1">void setLocoDCCAddress(byte locoID, int dccAddress);</td>
    <td width="581"><p>This function sets the loco DCC decoder address inthe nowRail internal array of 200 locos. <br>
            <br>
            <span class="style1">byte locoID:</span> A value of 0-199 that gets the Decoder number of the loco <br>
            <span class="style1">int dccAddress:</span> A value between 1 - 10238 (some DCC systems will only allow addresses up to 9,999) that the loco should be set to.<br>
            <br>
            <span class="clock">EXAMPLE</span><br>
            <br>
            <span class="style1">myLayout.setLocoDCCAddress(3, 1234);</span>//Will update the locoID 3 in the array to DCC address 1234<br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">byte getLocoDCCFuncState(byte locoID, byte funcNum);</td>
    <td><p>This function gets the status of a loco function. <br>
            <br>
            <span class="style1">byte locoID:</span> A value of 0-199 that gets the Decoder number of the loco </p>
      <p><span class="style1">byte funcNum:</span> A value of 0-63 (current decoders usually have a max value of 28 but this has been future proofed) Returns 0 = Off 1 = On <br>
            <br>
          <span class="clock">EXAMPLE</span><br>
            <br>
          <span class="style1"> myLayout.getLocoDCCFuncState(2, 4)</span>// This return the value of function 4 for locoID 2 
          <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">byte getLocoDCCFuncState(byte locoID, byte funcNum);</td>
    <td><p>This function gets the status of a loco function. <br>
            <br>
            <span class="style1">byte locoID:</span> A value of 0-199 that gets the Decoder number of the loco </p>
      <p><span class="style1">byte funcNum:</span> A value of 0-63 (current decoders usually have a max value of 28 but this has been future proofed) Returns 0 = Off 1 = On <br>
            <br>
          <span class="clock">EXAMPLE</span><br>
            <br>
          <span class="style1"> myLayout.getLocoDCCFuncState(2, 4)</span>// This return the value of function 4 for locoID 2 
          <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">String getLocoName(byte locoID);</td>
    <td><p>This function returns a String of the loconame if one has been input (Max 20 chars) <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199) <br>
            <br>
      <br>
      <span class="clock">EXAMPLE</span><br>
      <br>
      <span class="style1"> Serial.print("Name ");<br>
    Serial.println(myLayout.getLocoName(2)); </span>// Will display the name of locoID 2 <br>
    </p></td>
  </tr>
  <tr>
    <td class="style1">void setLocoName(byte locoID, String locoName);</td>
    <td><p>This function sets the Name of the loco (Max 20 chars, extra chars will be ignored) <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199) </p>
      <p><span class="style1">String locoName:</span> String of loco name (max 20 chars, extra ignored) <br>
        <br>
          <br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.setLocoName(2, "locoName");</span>// sets the name of locoID 2 to locoName <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">byte locoGetConsistState(byte locoID);</td>
    <td><p>This function gets the consist staus of the loco<br>
      <br>
      returned values are:<br>
      <br>
      0 .... Not in consist<br>
      1 .... Not in consist ... but consist direction set to Reverse <br>
      2 .... In Consist (FWD Direction)<br>
      3 ....
      In Consist (Rev direction)... will move in oppostie direction to lead loco. <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199)<br>
          <br>
          <br>
            <span class="clock">EXAMPLE</span><br>
          <br>
            <span class="style1">myConstState = myLayout.locoGetConsistState(locoID);;</span>// will return the consist state of the loco in the loco array (0-199) that is passed to the function in locoID <br>
        </p>
      </td>
  </tr>
  <tr>
    <td class="style1">void locoSetConsistState(byte locoID,byte consistState);</td>
    <td><p>This function sets the Consist state of the Loco <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199) </p>
      <p><span class="style1">byte consistState:</span> String of loco name (max 20 chars, extra ignored) <br>
        <br>
        0 .... Remove from consist in fwd direction<br>
1 .... remove from consist in Rev direction <br>
2 .... Add to Consist (FWD Direction)<br>
3 ....
      Add to Consist (Rev direction)... will move in oppostie direction to lead loco. <br>
          <br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.locoSetConsistState(21,3);</span>// sets the locoID 21 into a consist running in reverse to the controlling loco<br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">void locoTXLocoData(byte locoID);</td>
    <td><p>This function transmits the LocoID details passed to it, decoder address, function state and name. <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199) </p>
      <p><br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.locoTXLocoData(10);</span>// transmits LocoID 10 data over network <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">void setLocoRXState(byte state, byte updateLocoID);</td>
    <td><p>This function sets the receive state for a Loco ID. If 
receive state is set the locos data will be updated by a locoTXData 
transmission. <br>
            <br>
            <span class="style1">byte locoID:</span> locoID in the nowRail array  (0-199) </p>
      <p><span class="style1">byte state:</span> 0 ... will NOT receive. 1 ... set to receive <br>
        <br>
          <br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.setLocoName(2, "locoName");</span>// sets the name of locoID 2 to locoName <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">void setnowRailAddr(byte element, int changeVal);</td>
    <td><p>When nowRail starts all boards are given the layout address using the function<br>
	    <span class="style1">nowRail myLayout(0x00, 0x01, 0x02, 0x03);        </span><br>
        <br>
    This function allows the address to be changed while the board is 
running and was created to allow controllers to be swapped between 
layout.<br>
    The controller will revert to it's original address when restsarted.
</p>
      
      <p>            <br>
            <br>
            <span class="style1">byte element:</span> values 0-3 is the section of the address being changed </p>
      <p><span class="style1">int changeVal</span> :new address value between 0 and 255 <br>
        <br>
          <br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.setnowRailAddr(1,23);</span>// sets the 2nd element of the address to a value of 23 <br>
        </p></td>
  </tr>
  <tr>
    <td class="style1">String getnowRailAddr();</td>
    <td><p>This function gets the nowRail address of the unit as a String.<br>
      Used mainly in loco controllers
      <br>
            <br>
          <br>
          <br>
          <br>
            <span class="clock">EXAMPLE</span><br>
          <br>
            <span class="style1">myLayout.getnowRailAddr();</span>// Will return a String of the HEX values of the address elements <br>
        </p>
      </td>
  </tr>
  <tr>
    <td class="style1">void locoTXAllLocoData(void);</td>
    <td><p>This function works through the array of 200 locos and 
transmits their data over the system to any controller set to receive 
them <br>
            <br>
          <br>
          <br>
            <span class="clock">EXAMPLE</span><br>
          <br>
            <span class="style1">myLayout.locoTXAllLocoData(void);</span>//data will transmit <br>
        </p>
      </td>
  </tr>
  <tr>
    <td class="style1">void locoRXAllLocoData(int state)</td>
    <td><p>This function allows or stops the controller from receiveing loaco data from<span class="style1"> locoTXAllLocoData()</span> function.<br>
        <br>
          Controller stops receiving when it has received the full 200 loco transmissions <br>
            <br>
            <span class="style1">int state:</span> 0 = Not receiving, &gt;0 will receive </p>
      <p><br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.setLocoName(2, "locoName");</span>// sets the name of locoID 2 to locoName <br>
        </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<p></p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="EEPROM"></a>24LC256 EEPROM<br>
              <br>
      </span>ESP32 and ESP8266 boards DO NOT have built in EEPROM.<br>
      <br>
      I have therefore included the ability to add a 24LC256 EEPROM. 
This currently stores the layout time at regular intervals so that on 
restarting the layout the clock will continue from it's last position. 
It also stores an array of loco data storing data for a roster of 200 
locos. <br>
      <br>
      <br>
      The following lines must be uncommented in nowrail_user_setup.h to use the EEPROM<br> 
      <br>
      <span class="style1">#include "Wire.h"</span></p>
      <p><span class="style1">#define NOWDisc 0x50    //Default Address of 24LC256 eeprom chip in Board</span><br>
        <br>
          Once these lines are added the layout clock will update the 
EEPROM every 2 minutes so that on restart the layout will start from a 
time within 2 minutes of shut off time.<br>
          <br>
          Loco data is stored  in an array that is saved in EEPROM and restored on restart.<br>
          This data inclused the loco DCC address.<br>
          Loco Function States<br>
          Loco Name (maximum of 20 chars).
          <br>
          <br>
      This data is available in the loco controller functions. <br>
      <br>
      <span class="style9">Components</span><br>
      <br>
      <a href="https://www.amazon.co.uk/dp/B09JZ8B7C3?tag=digitaltown09-21" target="_blank">24LC256 EEPROM </a> <br>
      <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> </p>
      <p><img src="Digital%20Town%20-%20nowRail_files/EEPROM.jpg" alt="ESP32 EEPROM Circuit" width="950" height="762"><br>
        <br>
        For more information see <a href="https://www.digitaltown.co.uk/components1524LC256EEPROM.php" target="_blank">24LC256EEPROM Tutorial</a> <br>
        <br>
        <br>
      </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p class="style9"><a name="DCCEX"></a>DCC EX Connection </p>
      <p><a href="https://youtu.be/RgyuyBOvS0g" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/78nowrailDCCEX.jpg" alt="nowRail Connecting to DCC-EX" width="425" height="239" border="0"></a>
        <br>
        <br>
      The system connects to DCC EX using Serial2 on an ESP32 Dev Module Board.<br>
      <br>
      DCC EX will receive all valid loco speed and function commands as 
well as any accessory decoder address between 1 and 2000. Addresses 
higher than these will still be dealt with as normal by nowRail but are 
invalid on most DCC systems. <br>
      <br>
      The following lines must be uncommented in nowrail_user_setup.h <br> 
      <br>
      <span class="style1">#define DCCEXSSERIAL2_ON</span></p>
      <p>If you want to check the commands being sent to DCC EX uncomment this line so commands appear in the serial monitor. <br>
        <span class="style1">#define DCCEXSERIAL_ON&gt;</span><br>
        <br>
      For more information on DCC EX visit<a href="https://dcc-ex.com/" target="_blank"> https://dcc-ex.com</a></p>
      <table width="950" border="0">
        <tbody><tr>
          <td width="270"><p><span class="clock">Circuit</span><br>
              <br>
              <span class="style10">WARNING</span>: The Arduino Uno/mega is 5v, an ESP32 is 3.3v<br>
            <br>
            The ESP32 can transmit 3.3v to the Arduino without any problem.<br>
            However sending 5v from the Arduino to the ESP32 will wreck your ESP32. <br>
          </p>
            <p>As nowRail currently does not receive any transmission from DCC EX it does not require an connection from the Arduino TX pin. </p>
            <p>The circuit is just 2 connections.<br>
                <br>
              The first is ESp32 TX2 (pin 17) to Arduino Uno/Mega RX0 (pin 0). <br>
              <br>
              <br>
            The second connection is to connect the Arduino and ESP32 Gnd's </p></td>
          <td width="648"><img src="Digital%20Town%20-%20nowRail_files/DCCEX.jpg" alt="nowRail to DCC-EX Connection" width="648" height="410"></td>
        </tr>
      </tbody></table>      
      <table width="950" border="1">
        <tbody><tr>
          <td colspan="2"><p><span class="style9"><a name="locoControl"></a>DCC-EX Controller functions </span></p>
            <p>DCC-EX does not require many specific functions as it 
passes on Accessory Commands, Loco Speed and Loco function commands from
 the nowRail system. <br>
                  <br>
            NOTE: DCC Accessory commands are limited to values 1-2000. 
Commands greater than 2000 will work within nowRail but will not be 
passed on to DCC-EX <br>
            </p></td>
        </tr>
        <tr>
          <td width="353" class="style1"><p>sendPowerCommand(byte Command, int dccAddr, byte dccSpeed, byte dccDir)             </p>
            <p>&nbsp;</p></td>
          <td width="581"><p>This function sends a Power command to DCC-EX <br>
              <br>
                DCC-EX can be set to power up automatically or a power command can be sent. </p>
            <p>The loco data is NOT required for DCC-EX power commands <br>
                  <br>
                <span class="style1">byte Command:</span> 0 = Turn OFF DCC EX, 1 = Turn ON </p>
            <p><span class="style1">int dccAddr:</span> Not required for DCC EX, use 0</p>
		      <p><span class="style1">byte dccSpeed:</span>Not required for DCC EX, use 0</p>
<p><span class="style1">byte dccDir:</span>Not required for DCC EX, use 0</p>
<p> <br>
                  <span class="clock">EXAMPLE</span><br>
                  <br>
                <span class="style1">myLayout.sendPowerCommand</span>(1,0,0,0);//Turn on DCC-EX <br>
                <br>
                <span class="style1">myLayout.sendPowerCommand</span>(0,0,0,0);//Turn off DCC-EX 
                <br>
                <br>
            </p></td>
        </tr>
      </tbody></table>      <p><br>
        <br>
      </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="950" colspan="2"><p class="style9"><a name="MP3"></a>MP3 Player Control  </p>
        <p>           <a href="https://youtu.be/91_2KRJqaWs?si=wdd0SGMvDGmofCaO" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail101MP3Player.jpg" alt="nowRail 1.0.1 MP3 player implementation" width="425" height="239" border="0"></a></p>
        <p>MP3 player control was added in Version 1_0_0<br>
            <br>
            The system works over Serial2 so requires an ESP32 Dev 
Module or an alternate board that has built in Serial2 as all boards 
will be controlled via Serial2 (UART) control.<br>
            <br>
            MP3 boards that can be used are: DY-SV5W, DY-SV8F, DY-HV8F, DY_HV20T, JQ8900 (<span class="style10">Warning: JQ8900 works but is poor quality and I have had 2 failures</span>).<br>
            <br>
            More information on the boards including data sheets are available at:<br>
            <br>
            <a href="https://www.digitaltown.co.uk/components.php#DYHV8F" target="_blank">DY-HV8F and DY_HV20T </a>10-20W </p>
        <a href="https://www.digitaltown.co.uk/images/projects/nowRail/NCE.png" target="_blank"></a>
        <p><a href="https://www.digitaltown.co.uk/64DYSV5WESP32ESP8266.php" target="_blank">DY-SV5W, DY-SV8F</a> 5w </p>
        <p><a href="https://www.digitaltown.co.uk/components.php#JQ8900" target="_blank">JQ8900</a><br>
          <br>
          <img src="Digital%20Town%20-%20nowRail_files/mp3Players.png" alt="Mp3 players: DY-SV5W, DY-SV8F, DY-HV8F, DY_HV20T, JQ8900" width="950" height="500"><br>
        </p>
        <p>The following lines need to be uncommented in nowrail_user_setup.h
          <br>
            <br>
            //Serial 2 Pins Best on ESP32 Dev Module, some boards DO NOT have Serial 2
            <br>
            <br>
            <span class="style1">#define SERIALRX2 16</span> //define the Serial2 RX pin for your board <br>
            <span class="style1">#define SERIALTX2 17</span> //define the Serial2 TX pin for your board   </p>
        <p>//MP3 Player DY-SV5W, DY-SV8F, DY-HV8F, DY_HV20T, JQ8900
          This sets up Serial 2 using the pins defined in SERIALRX2 and SERIALTX2
          <br>
          <br>
          <span class="style1">#define MP3BUSYPIN 15</span>  //15 is the interrupt pin that is connected to the MP3 Busy pin          <br>
          <span class="style1">#define MP3NUMTRACKS 20</span> //defaults to 20 commands, increase number if more commands (accessories) are required
          <br>
          <span class="style1">#define MP3INTERVALMIN 250</span>  //random time gaps min...WARNING times below 250 may lead to odd results as MP3 player may not react quick enough
          <br>
          <span class="style1">#define MP3INTERVALMAX 10000</span> //random time gaps max
          <br>
          <span class="style1">#define MP3VOLUME 27</span>  //default volume (volumes are 0-30) <br>
          <br>
          <span class="style9">Circuit Diagram </span><br>
          <br>
          This is a typical circuit digram(click for larger version) for the various MP3 players. <br>
          NOTE: DY-HV8F requires 6-35v, other boards require 5v, check board specs. <br>
          <br>
          <a href="https://www.digitaltown.co.uk/images/components/DYHV8F/DYHV8FCircuit.png" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/DYHV8FCircuit.png" alt="nowRail Mp3 player circuit" width="950" height="462" border="0"></a>          <br>
          <br>
        </p>
      </td>
  </tr>
  <tr>
    <td><span class="style1">void mp3PlayVolume(int vol);</span></td>
    <td><p>This function sets the volume of the MP3 player in a range between 0 and 30 (Max) <br>
        <br>
          This can be called anywhere. <br>
          <br>
          <span class="style1">int vol :</span> A value of 0-30 that sets the volume of the board </p>
      <p><br>
          <span class="clock">EXAMPLE</span><br>
          <br>
          <span class="style1">myLayout.mp3PlayVolume(20); </span>//set mp3 volume to 20</p></td>
  </tr>
  <tr>
    <td><span class="style1">void addMP3PlayTrack(int accNum, int dirOn, int trackNum, int maxTrackNum, int mode);</span></td>
    <td><p>This adds an MP3 command that will respond to a function command and is used in the setup(); <br>
          <br>
          <span class="style1">int accNum</span>: The accessory number the function responds to </p>
      <p><span class="style1">int dirOn </span>: The accessory direction that turns the function on </p>
      <p><span class="style1">int trackNum</span>: The track number on 
the SD Card or internal memory that the function should play if a single
 track of the first in the range if playing multiple tracks.<br>
        <br>
        <span class="style1">int maxTrackNum</span>: The highest track in a range when playing multiple tracks </p>
      <p><span class="style1">int mode :</span> 0 = a single track will 
be played when the function is called. 1 = the tracks in the range 
trackNum to MaxTrackNum will play in a random order.<br>
          <br>
          <span class="clock">EXAMPLES</span></p>
      <p><span class="style1">void setup() {<br>
Serial.begin(115200);//Standard Serial Output to Serial monitor<br>
Serial.println("nowRailV1_0_0");</span><br>
      </p>
      <p> //Start the system<br>
        <span class="style1">myLayout.init();</span>//This functions sets up ESP-NOW as well as other items needed for the system to run<br>
  <br>
        <span class="style1">myLayout.addMP3PlayTrack(1001,1, 11, 11, 0);</span> //When address 1001 direction 1 is selected track 11 will play once<br>
        <span class="style1">myLayout.addMP3PlayTrack(1002, 1, 1, 5, 1);</span> //When address 1002, direction 1 is selected tracks 1-5 will play in random sequence<br>
        <span class="style1">myLayout.addMP3PlayTrack(1003, 1, 6, 10, 1);</span> //When address 1003, direction 1 is selected tracks 6-10 will play in random sequence<br>
        <span class="style1">myLayout.addMP3PlayTrack(1004, 1, 11, 12, 1);</span> //When address 1004, direction 1 is selected tracks 11-12 will play in random sequence<br>
  <br>
        <span class="style1">myLayout.mp3PlayVolume(20);</span> //set mp3 volume to 20<br>
        <span class="style1">}</span></p>
      <p><br>
        <br>
      </p></td>
  </tr>
  
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p class="style9"><a name="NCE"></a>NCE Cab Bus  Connection </p>
        <p><a href="https://youtu.be/HVGBwAo9SNQ" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/163NCECabBus.jpg" alt="nowRail NCE Cab Bus" width="425" height="240" border="0"></a><br>
          <br>
          The system connects to NCE Cab BUS using Serial2 via a MAX485 break out board from a ESP32 Dev Module Board.<br>
          <br>
          nowRail sets itself up as 5 byte smart cab, capable of sending loco speed. function and accessory commands
          to Cab Bus that will then be processed by the NCE command station. <br>
          <br>
          NCE communication was added in nowRail version 0_8_1 <br>
          <br>
          The following lines must be uncommented in nowrail_user_setup.h <br>
          <br>
        <span class="style1">#define CAB_BUS_ADDRESS 4</span> //This 
line sets up nowRail as a smart cab with address of 4 (be aware NCE 
PowerCab has a limited number of addresses it polls) </p>
        <p><span class="style1">#define RS485ENABLLEPIN 4</span> //This line sets the pin that the enable pin from the MAX485 module will be controlled thorugh. <br>
            <br>
          If you want NCE clock to be layout Masterclock uncomment this 
line. Make sure no other node is set as MASTERCLOCK. You DO NOT need an 
EEPROM as the NCE Cab Bus  will control the time. <br>
            NOTE: When NCE cab bus starts up Hand controllers time may 
stop or give strange results for up to 2 minutes while nowRail syncs 
with the NCE bus time.
              <br>
          There may also be a slight lag if you change the NCE clock speed. <br>
        <span class="style1">#define MASTERCLOCK_ON</span></p>
        <p>This line should be uncommented (from version 1.2.1 onwards) 
This decides how loco decoder addresses 1-128 will be passed to the NCE 
Can bus.<br>
          <br>
          <span class="style1">#define CAB_BUS_SHORTADDRON 0</span></p>
        
        <p>If set to 0 addresses 1-28 will be treated as short 
addresses(1 - 128), if set to 1 addresses 1-128 will be sent as long 
addresses 0001 - 0128 <br>
        <br>
        <span class="style9">Components</span><br>
        <br>
        <a href="https://www.amazon.co.uk/dp/B06XHHWLMW?tag=digitaltown09-21" target="_blank">MAX485/RS485 Module</a> <br>
		<a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br>
        <br>
        Now just build up the circuit below (Click image for larger Version) </p>
        <a href="https://www.digitaltown.co.uk/images/projects/nowRail/NCE.png" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/NCE.png" alt="nowRail to DCC-EX Connection" width="950" height="560" border="0"></a>
        <p>Click for larger image <br>
            <br>
            <a href="https://www.digitaltown.co.uk/images/projects/nowRail/ncebreadboard.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/ncebreadboard.jpg" alt="NCE Cab bus circuit" width="950" height="712"></a></p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="DCCINPUT"></a>DCC Controller input <br>
          <a href="https://youtu.be/6ZjmP6hau1c" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/80DCCinput.jpg" alt="DCC to nowRail connection" width="425" height="240" border="0"></a><br>
      </span>With the addition of a simple bit of circuitry commands from any DCC control system can be passed on to nowrail.<br>
      <br>
      At the moment I have only configured the system for accessory decoder commands.<br>
      <br>
      A step by step walk through of the circuit is available at <a href="https://www.digitaltown.co.uk/79DCCDecoderCircuit.php" target="_blank">https://www.digitaltown.co.uk/79DCCDecoderCircuit.php</a></p>
      <p>BLUE wire (the one that connects to pin 2 on the Arduino) to pin 4 on an ESP32 Dev Module<br>
          <br>
          <br>
        The following lines must be uncommented in nowrail_user_setup.h <br>
        <br>
        <span class="style1">#define DCCDECODERPIN 4 </span>//If board is being used as a DCC decoder this is the interrupt pin<br>
        <span class="style1">#define ONEBITTIME 130  </span>// If your 
DCC system does not work you can change this value. NCE systems and 
DCC-EX seem to work between 130 - 180. Make sure your wiring is correct 
before messing with this value. <br>
        <br>
      </p>
      <table width="950" border="0">
        <tbody><tr>
          <td width="321"><p><span class="clock">The Circuit</span><br>
              <br>
              <span class="style10">WARNING:</span> Do not conenct your ESP32 directly to the DCC track output.<br> 
              <br>
            This is the circuit to connect your DCC track signal to nowRail.<br>
            <br>
          The components you need are:<br>
          <br>
          1 x 6N137 Optoisolator<br>
          1 x 1N4148 Diode <br>
          1 x 1k Ohm resistor<br>
          2 x 10k Ohm resistor<br>
          2 x small jumper wires <br>
          <br>
          <span class="style9">Components</span><br>
          <br>
          <a href="https://www.amazon.co.uk/dp/B08DR5T897?tag=digitaltown09-21" target="_blank">ESP32 Dev  Module</a> <br>
          <br>
          <span class="style1">IMPORTANT:</span><br>
          <br>
          Please note the Orange Jumper running alongside the 2 x 10k Ohm resistors.<br>
          <br>
          Note the Blue jumper running alongside the 1N4148.
</p>
            <p>&nbsp;</p>
            <p>A step by step walk through of the circuit is available at <a href="https://www.digitaltown.co.uk/79DCCDecoderCircuit.php" target="_blank">https://www.digitaltown.co.uk/79DCCDecoderCircuit.php</a></p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp;</p>
            <p>&nbsp; </p></td>
          <td width="597"><img src="Digital%20Town%20-%20nowRail_files/DCCDecoderCircuit.jpg" alt="DCC Decoder Circuit" width="597" height="593"></td>
        </tr>
      </tbody></table>
      <p><br>
        <br>
        <br>
      </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="JMRI"></a>JMRI</span></p>
      <p><span class="style9"><br>
             <iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/5YLXue_GavU.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
             <br>
      </span>NOTE: I have had to learn to use JMRI to connect to nowRail. 
      I will describe the set up I have used as it's not a program I use for my layout. <br>
      <br>
      Connection is VIA USB from computer to ESP32.<br>
      <br>
      Two Lines need to be uncommented in nowrail_user_setup.h<br>
      <br>
	   <span class="style1">#define JMRICMRI &nbsp;1</span> &nbsp;//JMRICMRI connection, this uses Serial at 115200 baud rate, VALUE 1 is CMRI node number (0-127) </p>
      <p><span class="style1">#define JMRICMRINUMCARDS 24</span> //gives 24 x 8 sensors (192), increase value if required </p>
      <p>        WARNING: Comment out the line <br>
        //#define DIAGNOSTICS_ON
          <br>
          <br>
          This is because any diagnostic data will be sent to JMRI. Note
 the Serial Monitor WILL NOT work while connected to JMRI <br>
          <br>
          Set up (will be explained in video)<br>
          <br>
          <span class="style1">Edit&gt;Preferences 
          <br>
          <br>
          Top Left "Connections" </span><br>
          <br>
          Add connection:<br>
          <span class="style1">Manufacturer C/MRI          </span><br>
          <br>
          System Connection:<br>
          <span class="style1">Serial</span><br>
          <br>
          Serial Port<br>
          <span class="style1">Whatever COM port your ESP32 is using</span><br>
          <br>
          Connection prefix <br>
          <span class="style1">I left mine as C</span><br>
          <br>
          Connection name<br>
          <br>
          <span class="style1">I left as C/MRI</span><br>
          <br>
          Check Additional Connection settings<br>
          <br>
          Baud Rate <br>
          <br>
          <span class="style1">115200<br>
          </span><br>
          Output Interval (ms)<br>
          <br>
          <span class="style1">Left as 250</span><br>
          <br>
          Configure Nodes
          <br>
          <br> 
          Node address<br>
          <br>
          <span class="style1">I set mine to 1,</span> this will prefix your Lights, Sensors and Turnout numbers
          <br>
          <br>
          Node Type<br>
          <br>
          <span class="style1">I used USIC_SUSIC</span><br>
          <br>
          Receive Delay<br>
          <br>
          <span class="style1">0</span></p>
      <p>Card Size<br>
        <br>
        <span class="style1">24-bit          </span><br>
        </p>
      <p>Card Address/Card Type<br>
        <br>
        <span class="style1">I set cards 0-7 as OUTPUTS and 8-15 as INPUTS        </span><br>
        <br>
        That gave me 64 INPUTS (sensors) and 64 OUTPUTS (Lights/Turnouts), increase the number of you need more. <br>
        <br>
        Enable Polling at Start up<br>
        <br>
        <span class="style1">Checked        </span><br>
        <br>
          <br>
        </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="Diagnostics"></a>Diagnostics <br>
              <br>
      </span>Diagnostics posts a lot of information to the Serial Monitor to allow you to see what is happening,<br>
      <br>
      Once you have everything working just comment the line out to turn it off and speed up your system.
      <br>
      <br>
      <br>
      The following lines must be uncommented in nowrail_user_setup.h <br>
      <br>
      <span class="style1">#define #define DIAGNOSTICS_ON </span>//Will display all incoming messages in Serial with DIAG&gt; Prefix<br>
    </p>      </td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="WIFI"></a>Wifi Channel  <br>
              <br>
      </span>From 1.4.4 it is now possible to set and even change the wifi channel that nowrail operates on.</p>
      <p><a href="https://youtu.be/zlGnaPfzrbY" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/159wifi.png" alt="nowRAil wifi channels and encryption" width="425" height="240" border="0"></a><br>
          <br>
        These functions are designed for extreme exhibition scenarios 
and are probably not needed even then. However they have been added for 
peace of mind. <br>
          <br>
        By default ESP-NOW uses Channel 1 or the channel of the access 
point it is connected to when connecting to an Access Point. <br>
          <br>
        To change the default channel go to nowrail_user_setup.h. Only 
enter values 1,6 or 11. These are the only non overlapping channels, 
other channels will degrade the system so nowRail ignores them. <br>
          <span class="style1">#define WIFICHANNEL 1</span><br>
          <br>
        Encryption can now be enabled. This should be disbaled if connecting to pre 1.4.4 sketches.<br>
        The encryption scamples the layout address in the data packet.<br>
          <span class="style1">#define ENCRYPT </span> //uncomment to run encryption on broadcasts<br>
          <br>
        The follwing definition when enabled will cause a board to swap 
between channels 1,6 and 11 at 3 second intervals until it finds the 
MASTERCLOCK time broadcast so MASTERCLOCK MUst be enabled on one board 
on the layout. <br>
        This allows the layout wifi channel to be changed in real time. 
This enables the whole layout to swap channel should a channel become 
distrupted (not that it's ever happened yet). <br>
          <br>
          <span class="style1">#define WIFIMASTERCLOCKCHANGE</span> ////this allows the boards wifi channel to be changed while running<br>
          <br>
        The channel chnage function is demonstrated below, this is 
chnaging the channel to channel 6. The board generating the MASTERCLOCK 
(even if time is set at Zero) is the board that will instantly change 
channel (if <span class="style1">WIFIMASTERCLOCKCHANGE</span> set) . All other boards will then lose contact with the MASTERCLOCK and will search on other channels after 3 seconds only if <span class="style1">WIFIMASTERCLOCKCHANGE</span> is set. <br>
        If a loco is added to the layout usnig nowRail as a decoder it 
will instantly start searching for the MASTERCLOCK even if it missed the
 command when initially sent. <br>
          <br>
        The fiunction below can be triggered by a button/GT911 or LCD touch screen of choice. <br>
          <br>
          <span class="style1">myLayout.changeWifiChannel(6);</span>//send change channel <br>
        </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="Debounce"></a>Button/Sensor Debounce <br>
              <br>
      </span>This value sets the button/sensor debounce level for the layout.<br>
      <br>
      Lower values make the buttons/Sensors more sensitive but you are 
more likely to get double presses. Too high a value can make the buttons
 seem sluggish.
      <br>
      <br>
      The following lines can be edited in nowrail_user_setup.h <br>
      <span class="style1">#define SENSORDEBOUNCE 100</span> //Set the sensor debounce speed to0.1 seconds<br>
      <span class="style1">#define BUTTONDEBOUNCE 250</span>  //Set the button debounce speed to 0.25 seconds...increasing value reduces double presses but too high and system is sluggish<br>
    </p></td>
  </tr>
</tbody></table>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="TURNOUTPULSE"></a>TURNOUTPULSE<br>
              <br>
      </span>This value sets the pusle length in milliseconds when a 
pulse is required for solenoid type point motors, lower values will 
kmake the pulse shorter, higher values will make the pulse longer (for 
sticky motors). <br>
      <br>
      The following line can be edited in nowrail_user_setup.h <br>
      <br>
	  <span class="style1">#define TURNOUTPULSE 500</span> //0.5 second pin HIGH to switch point/turnout<br>
	  <br>
    </p></td>
  </tr>
</tbody></table>
<h2><a name="ExampleProjects"></a>nowRail example projects </h2>
<p>&nbsp;</p>
<table width="950" border="1">
  <tbody><tr>
    <td width="934"><p><span class="style9"><a name="touchlocoControl"></a>nowRail LCD touch screen controller <br>
          </span><span class="style9"><a href="https://youtu.be/bTWhonODod4" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/117controller.jpg" alt="nowRail loco controller" width="425" height="240" border="0"></a></span><span class="style9"> <a href="https://youtu.be/neqb5IgX8Qc" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/121Update.jpg" alt="nowRail v1.2.1 hand controller updates" width="425" height="240" border="0"></a><br>
          <br>
          <a href="https://youtu.be/i53tkOre3VA" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/130controller.png" alt="nowRail 1.3.0 Loco controller" width="425" height="240" border="0"></a> <a href="https://youtu.be/GArjTuWVTgg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/131Controller.png" alt="nowRail 1.3.1 Loco controller" width="425" height="240" border="0"></a><br>
          </span>This is a prototype controller I built for my own Isle 
of Mudd layout. The controller will work with DCC-EX via the nowRail 
interface or NCE cab bus, again using the nowRail interface. <br>
          <br>
        The basic controller has 5 components<br>
        <br>
        ESP32 Dev Module <br>
        3.5" 480x320 SPI LCD Screen with capacitive touch sensor, I have
 tested with the ILI9486 FT6236 and ILI9488 FT6236 versions of the 
screen, see the photos and link below. <a href="https://www.aliexpress.com/item/1005005775415776.html" target="_blank">This is the link to the one I bought </a>.
I bought the ILI 9486 FT6236 version from the link.<br>
        Rotary Encoder Module<br>
        24LC256 EEPROM chip<br>
        10k Ohm resistor
        <br>
        <br>
        <span class="clock">The project requires 2 libraries</span> <br>
        <br>
        TFT_eSPI by Bodmer (I used version 2.5.43) I User_Setup config 
files for the 9486 and 9488 are in the project download file. Can be 
installed from Arduino Library manager or <a href="https://github.com/Bodmer/TFT_eSPI" target="_blank">https://github.com/Bodmer/TFT_eSPI</a><br>
        FT6236 by Dustin Watts <a href="https://github.com/DustinWatts/FT6236" target="_blank">https://github.com/DustinWatts/FT6236</a> version 1.0.2 (included in project download file) </p>
      <p class="style9">Pin Connections</p>
      <p><span class="style1">EEPROM </span>Uses the nowRail configuration see <a href="#EEPROM">EEPROM</a><br>
        <br>
        <span class="style1">Rotary Encoder:</span> Button (SW) to ESP32 Pin 25, Encoder Left (CLK) ESP32 pin 26, Encoder Right (DT) ESP32 pin 27 <br>
        <br>
        <span class="style1">LCD Touch screen </span>
      </p><table width="42%" border="1" cellpadding="0" cellspacing="0">
  <colgroup><col width="128*">
  <col width="128*">
  </colgroup><tbody><tr valign="top">
    <td width="46%"><p align="center"> <strong>ILI9488/6  			FT6236 Touch Screen</strong></p></td>
    <td width="54%"><p align="center"> <strong>ESP32  			DEV Module</strong></p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>VDD</p></td>
    <td width="54%"><p>3.3v</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>GND</p></td>
    <td width="54%"><p>GND</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>CS</p></td>
    <td width="54%"><p>D15</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>RST</p></td>
    <td width="54%"><p>D4</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>D/C</p></td>
    <td width="54%"><p>D2</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>SDI</p></td>
    <td width="54%"><p>D23</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>SCK</p></td>
    <td width="54%"><p>D18</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>BL</p></td>
    <td width="54%"><p>3.3v</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>SDO</p></td>
    <td width="54%"><p>D19</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>NC/3v3</p></td>
    <td width="54%"><p>Not  			Connected</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>CTP_SDA</p></td>
    <td width="54%"><p>D21</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>CTP_SCL</p></td>
    <td width="54%"><p>D22</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>CTP_INT</p></td>
    <td width="54%"><p>Not  			Connected</p></td>
  </tr>
  <tr valign="top">
    <td width="46%"><p>CTP_RST</p></td>
    <td width="54%"><p>Not  			Connected</p></td>
  </tr>
</tbody></table>
      <p></p>
      <p>For basic tutorials on setting up these screens see this link        <a href="https://www.digitaltown.co.uk/61ESP32ILI9488LCDTouchScreen.php" target="_blank">ILI9488</a></p>
      <p><span class="clock">Complete Project Code </span><br>
        <br>
        <a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_4_4_HandController3_1.zip" target="_blank">Click to download project file nowRailV1_4_4_HandController3_1.zip</a>: 02/11/2025 Bug dixed in Accessory Control. Thanks to Sven Erik for reporting it. channel changes <br>
        <br>
        Previous Versions </p>
      <p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_3_1HandControllerV2_1.zip" target="_blank">nowRailV1.3.1HandcontrollerV2.1 </a><br>
        <br>
        <a href="https://www.digitaltown.co.uk/inofiles/nowRail/touchscreencontrollerPCB.zip" target="_blank">PCB files for Download</a> I sent these files to PCBWay and got 5 made for about Â£8 including postage, VAT and shipping to UK.<br>
        The new case files have been designed to use this PCB. <br>
          <br>
      </p>
      Non PCB Version
      <table width="950" border="0">
        <tbody><tr valign="top">
          <td width="321">
           <p><span class="clock">Click for Larger version </span><br><a href="https://www.digitaltown.co.uk/images/projects/nowRail/handcontrollerBreadboard.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handcontrollerBreadboard.jpg" alt="nowRail loco controller breadboard" width="425" height="405" border="0"></a></p>
           <p>This is the type of 480 x 320 screen I am using.<br>
               <br>
                On Aliexpress they are listed as ILI9486 ILI9288 FT6236 <br>
                  <a href="https://www.aliexpress.com/item/1005005775415776.html" target="_blank">This is the link to the one I bought </a><br>
             <br> 
             This is the ILI 9486 FT6236 version from the link above <br>
             <br>
             Click on images for larger versions</p>
           <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/touchScreen1.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/touchScreen1.jpg" alt="TouchScreenRear" width="400" height="300" border="0"></a> </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/touchScreen2.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/touchScreen2.jpg" alt="TouchScreenRear" width="400" height="300" border="0"></a></p></td>
          <td width="597"><p><span class="clock">Click for Larger version </span><br>
              <a href="https://www.digitaltown.co.uk/images/projects/nowRail/handcontrollercased.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handcontrollercased.jpg" alt="nowRail loco controller" width="425" height="718" border="0"></a></p>
            <p>The STL and DesignSparks for the case are available for download here.<br>
            These file are copyright of Digital Town and not for 
commercial resale or for the building of commercial products without 
expressed permission.<br>
              <br>
              They may be used by clubs or individuals to build their own controllers without limits. <br>
              <br>
            Further information on case construction is in the Read Me 
file, the STL files and the original design files can be dlownload for 
free from cult3D using the link below. </p>
            <p><a href="https://cults3d.com/:2661444" target="_blank">Case 3D Print files  (original DIY PCB)</a></p>
            <p>Circuit Diagram, click for larger version </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/lococontrollercircuit.png" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/lococontrollercircuit.png" alt="nowRail touch screen controller circuit" width="425" height="304" border="0"></a></p></td>
        </tr>
      </tbody></table>
	  PCB Version
      <table width="950" border="0">
        <tbody><tr valign="top">
          <td width="321">
           <p><span class="clock">Click for Larger version </span><br><a href="https://www.digitaltown.co.uk/images/projects/nowRail/handPCBVersion.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handPCBVersion.jpg" alt="nowRail Hand controller PCB version" width="425" height="821" border="0"></a></p>
           <p>This is the type of 480 x 320 screen I am using.<br>
               <br>
                On Aliexpress they are listed as ILI9486 ILI9288 FT6236 <br>
                  <a href="https://www.aliexpress.com/item/1005005775415776.html" target="_blank">This is the link to the one I bought </a><br>
             <br> 
             This is the ILI 9486 FT6236 version from the link above <br>
             <br>
             Click on images for larger versions</p>
           <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/touchScreen1.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/touchScreen1.jpg" alt="TouchScreenRear" width="400" height="300" border="0"></a> </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/touchScreen2.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/touchScreen2.jpg" alt="TouchScreenRear" width="400" height="300" border="0"></a><br>
              <br>
              <br>
            PCB Files<br>
            <br>
            PCB is used at your own risk. <br>
              <br>
              <a href="https://www.digitaltown.co.uk/inofiles/nowRail/touchscreencontrollerPCB.zip">Download PCB Files 
              </a></p><p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/handPCB.jpg" target="_blank">PCB and USB C connector <img src="Digital%20Town%20-%20nowRail_files/handPCB.jpg" alt="PCB and USB C connector" width="425" height="566" border="0"></a></p></td>
          <td width="597"><p><span class="clock">Click for Larger version </span><br>
              <a href="https://www.digitaltown.co.uk/images/projects/nowRail/handPCBInternal.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handPCBInternal.jpg" alt="nowRail hand controller PCB version" width="425" height="566"></a><br>
              <br>
          This version has a battery installed to make it cable free. </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/handPCBBatteryInternal.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handPCBBatteryInternal.jpg" alt="noeRail hand controller" width="425" height="566" border="0"></a><br>
              <br>
            The battery I used is located in a small box attached to the case base. </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/handbatteryBox.jpg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/handbatteryBox.jpg" alt="nowRail case battery" width="425" height="566" border="0"></a><br>
            </p>
            
            <p>The STL and DesignSparks for the case are available for download here.<br>
            These file are copyright of Digital Town and not for 
commercial resale or for the building of commercial products without 
expressed permission.<br>
              <br>
              They may be used by clubs or individuals to build their own controllers without limits. <br>
              <br>
            Further information on case construction is in the Read Me 
file, the STL files and the original design files can be dlownload for 
free from cult3D using the link below. </p>
            <p><a href="https://cults3d.com/:2788645" target="_blank">Case 3D Print files for PCB Case </a></p>
            <p>Circuit Diagram, click for larger version </p>
            <p><a href="https://www.digitaltown.co.uk/images/projects/nowRail/lococontrollercircuit.png" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/lococontrollercircuit.png" alt="nowRail touch screen controller circuit" width="425" height="304" border="0"></a></p></td>
        </tr>
      </tbody></table>
      <p><br>
        <br>
        <br>
      </p></td>
  </tr>
</tbody></table>
<h2><a name="Tutorials"></a>nowRail How To Tutorials </h2>


<table width="950" border="1">
  <tbody><tr>
    <td valign="top" width="425"><p><a href="https://youtu.be/2Uf-gzGO0eg" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/SystemMonitor.png" alt="nowRail system monitor" width="425" height="240" border="0"></a></p>
      <p>This video shows how to use customFunction.ino to create a system monitor for nowRail.<br> 
        <br>
The monitor allows you to see the commands being send over the nowRail 
system on an I2C LCD display without the need to connect a computer. <br>
      <br>
      The code also shows how to use some of the different nowRail functions on the customFunctions.ino tab. </p></td>
    <td valign="top"><p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_3_3_LCDMonitorV1.zip" target="_blank">Source Code for this video</a></p>
      <p><br>
        <a href="https://www.digitaltown.co.uk/ESP32.php#1602" target="_blank">The I2C LCD Display code is based on the ESP32 1602 lesson, click for more information.</a></p>
      <p>Click image for larger diagram<a href="https://www.digitaltown.co.uk/images/lessons/ESP32_1602A_I2C_Circuit.png" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/ESP32_1602A_I2C_Circuit.png" alt="ESP32 1602A Liquid Crystal Display Circiut" width="425" height="317" border="0"></a>      </p>
      <p>        The custom functions used are:<br>
        <br>  <span class="style1">void nowAccComRec(int accNum, byte accInst) 
		</span></p>
      <p><span class="style1">void nowPanelUpdate(int accNum, byte accInst)
        </span></p>
      <p><span class="style1">void nowTimeEvents(byte clockSpeed, byte clockHour, byte clockMinute, byte clockSecond, byte clockDay)
        </span></p>
      <p><span class="style1">void nowLocoFuncUpdate(int locoAddr, byte nowFuncNum, byte nowFuncState)
        </span></p>
      <p><span class="style1">void nowLocoSpeedUpdate(int locoAddr, byte locoSpeed, byte locoDir)
        </span></p>
      <p><span class="style1">void nowPowerCommand(byte Command)</span>      </p>      </td>
  </tr>
   <tr>
    <td valign="top" width="425"><a href="https://youtu.be/GXlXMaAw16E" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/howToLocoDecoder.png" alt="nowRail loco decoder dead rail" width="425" height="240" border="0"></a></td>
    <td valign="top"><p><a href="https://www.digitaltown.co.uk/inofiles/nowRail/nowRailV1_3_3decoderV1.zip" target="_blank">Source Code for this video </a></p>
      <p>This how to shows the basics of using two functions from the 
customFunctions.ino tab can easily create a basic loco decoder powered 
either from the track or battery dead rail systems. <br>
        <br>
      The two functions used are:<br>
        <br>
		<span class="style1">void nowLocoSpeedUpdate(int locoAddr, byte locoSpeed, byte locoDir)     </span><br>
        <br>
      This function is triggered when any loco speed or direction change is broadcast. </p>
      <p class="style1">void nowLocoFuncUpdate(int locoAddr, byte nowFuncNum, byte nowFuncState) </p>
      <p>This function is triggered when any loco function change is broadcast. </p>     </td>
  </tr>
</tbody></table>

<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/4U3JsHjGbMg.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe> </p>
<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/WBDI8n6OPtA.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
 <p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/jr0FKyxV0y8.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe> </p>
 <p>  <iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/gvm_TA42CNg_002.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe> 
  </p>
	<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/hGj4ZGdbiwE.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
	
	<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/k91ijd881oI.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
	
	
	<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/4RajATPS1iM_003.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
	<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/4RajATPS1iM_003.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/nNEkZS6wEMg_002.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
<p><a name="Custom"></a><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/Imy_WF_eGG0.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/7lko7aTqhqs_003.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
<p><iframe width="560" height="315" src="Digital%20Town%20-%20nowRail_files/5YLXue_GavU_002.htm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></p>
<p><a href="https://youtu.be/DorqMx6g5p4" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail072update.jpg" alt="nowRail 0.7.2" width="425" height="239" border="0"></a></p>
<p><a href="https://youtu.be/UnJ6WPc1Spg"><img src="Digital%20Town%20-%20nowRail_files/nowRail_NCE_CabBus.jpg" alt="nowRail NCE Cab Bus" width="425" height="240" border="0"></a></p>

<p><a href="https://youtu.be/xKgqPWWVrK8" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail091update.jpg" alt="nowRail pca9685 leds" width="425" height="239" border="0"></a></p>
<p> <a href="https://youtu.be/91_2KRJqaWs?si=wdd0SGMvDGmofCaO" target="_blank"><img src="Digital%20Town%20-%20nowRail_files/nowRail101MP3Player.jpg" alt="nowRail 1.0.1 MP3 player implementation" width="425" height="239" border="0"></a></p>


<h2>Additional Resources </h2>
<p><a href="https://www.digitaltown.co.uk/70ESPNOWBroadcast.php">#70 ESP-NOW Broadcast Mode </a>06/03/2024</p>
<p><a href="https://randomnerdtutorials.com/esp-now-esp32-arduino-ide/">Random Nerds Getting Started with ESP-NOW (ESP32 with Arduino IDE) </a></p>
<p><a href="https://randomnerdtutorials.com/esp-now-esp8266-nodemcu-arduino-ide/">Random Nerds Getting Started with ESP-NOW (ESP8266 NodeMCU with Arduino IDE)</a></p>
<h2>Comments</h2>
<br>
For help or suggestions on new projects, please email the address in this image:<img src="Digital%20Town%20-%20nowRail_files/address.gif" align="bottom"> and use <span class="style1">nowRail</span> as a reference.</div>


</body></html>